<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Fitness & Langlebigkeits Tracker</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: '#5D5CDE',
            secondary: '#8B5CF6',
            success: '#22C55E',
            warning: '#F59E0B',
            danger: '#EF4444', // Rot für Gefahr/Reset
            info: '#3B82F6'
          }
        }
      }
    }
  </script>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"/>

  <style>
    body {
      font-family: 'Inter', sans-serif;
      transition: background-color 0.3s ease;
    }

    .dark body {
      background-image: linear-gradient(to top right, rgba(76, 29, 149, 0.15), rgba(30, 58, 138, 0.15), rgba(124, 58, 237, 0.15));
    }

    .card-transition {
      transition: all 0.3s ease;
    }

    .card-transition:hover {
      transform: translateY(-5px);
    }

    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button {
      opacity: 1;
    }

    /* Fade-in animation */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate-fade-in {
      animation: fadeIn 0.5s ease-in-out;
    }

    /* Styling for the iframe container */
    .iframe-container {
        transition: all 0.3s ease-out;
        overflow: hidden; /* Ensures content doesn't spill during transition */
    }

  </style>
</head>
<body class="min-h-screen bg-gradient-to-tr from-pink-100 via-blue-100 to-violet-100 bg-fixed dark:from-slate-900 dark:via-purple-900 dark:to-slate-900">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo, useRef, createContext, useContext, Component } = React;

    // --- Storage Fallback Implementation ---
    const memoryStorage = {
      _data: {},
      getItem(key) { return this._data.hasOwnProperty(key) ? this._data[key] : null; },
      setItem(key, value) { this._data[key] = String(value); },
      removeItem(key) { delete this._data[key]; },
      clear() { this._data = {}; }
    };
    const storage = (function() {
      try {
        localStorage.setItem('__storage_test__', 'test');
        localStorage.removeItem('__storage_test__');
        console.log("Using localStorage for persistence.");
        return localStorage;
      } catch (e) {
        console.warn('localStorage is not available. Using temporary in-memory storage.', e);
        return memoryStorage;
      }
    })();
    // --- End Storage Fallback ---

    // Theme context
    const ThemeContext = createContext();
    const ThemeProvider = ({ children }) => {
      const [isDark, setIsDark] = useState(() => {
        let darkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        try {
            const storedPref = storage.getItem('themePref');
            if (storedPref) darkMode = storedPref === 'dark';
        } catch (e) { console.warn("Could not read theme preference from storage.", e); }
        if (darkMode) document.documentElement.classList.add('dark');
        else document.documentElement.classList.remove('dark');
        return darkMode;
      });
      useEffect(() => {
        const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
        const handleChange = (e) => {
          try {
              if (!storage.getItem('themePref')) {
                  setIsDark(e.matches);
                  if (e.matches) document.documentElement.classList.add('dark');
                  else document.documentElement.classList.remove('dark');
              }
          } catch (e) {
              console.warn("Could not access storage in theme media query handler.", e);
              setIsDark(e.matches);
              if (e.matches) document.documentElement.classList.add('dark');
              else document.documentElement.classList.remove('dark');
          }
        };
        mediaQuery.addEventListener('change', handleChange);
        return () => mediaQuery.removeEventListener('change', handleChange);
      }, []);
      const toggleTheme = () => {
        setIsDark(prev => {
          const newValue = !prev;
          const themeValue = newValue ? 'dark' : 'light';
          try { storage.setItem('themePref', themeValue); } catch (e) { console.warn("Could not save theme preference to storage.", e); }
          if (newValue) document.documentElement.classList.add('dark');
          else document.documentElement.classList.remove('dark');
          return newValue;
        });
      };
      return <ThemeContext.Provider value={{ isDark, toggleTheme }}>{children}</ThemeContext.Provider>;
    };

    // Constants and Helpers
    const LS_KEYS = { GOALS: 'fitGoals', FOOD: 'fitFood', EX: 'fitEx', WATER: 'fitWater', WEIGHT: 'fitWeight', AGING: 'fitAging' };
    const TABS = { DASH: 'dashboard', FOOD: 'food', EX: 'exercise', GOALS: 'goals', AGING: 'aging', STATS: 'stats' };
    const TAB_LABELS = { dashboard: 'Übersicht', food: 'Essen', exercise: 'Training', goals: 'Ziele', aging: 'Langlebigkeit', stats: 'Statistik' };
    const initialGoals = { targetWeight: 70, dailyCalories: 2000, dailyProtein: 150, dailyCarbs: 250, dailyFat: 60, dailyWater: 2500, exerciseMinutes: 30 };
    const longevityItems = [
      { id: 'hiit', title: "HIIT-Einheiten pro Woche", info: "Steigert Mitochondrien, aktiviert Autophagie", target: 3 },
      { id: 'steps', title: "10.000 Schritte täglich", info: "Fördert kardiovaskuläre Gesundheit", target: 1 },
      { id: 'fasting', title: "Intermittierendes Fasten (16:8)", info: "Aktiviert Autophagie, reduziert Zellalterung", target: 1 },
      { id: 'omega3', title: "Omega-3 reiche Ernährung", info: "Senkt Entzündung, schützt Zellmembranen", target: 1 },
      { id: 'meditation', title: "Meditation/Atemübungen", info: "Reduziert Cortisol, schützt Telomere", target: 1 },
      { id: 'sleep', title: "7-8 Stunden Schlaf", info: "Fördert DNA-Reparatur, hormonelle Balance", target: 1 },
      { id: 'plants', title: "5+ verschiedene Pflanzen/Tag", info: "Fördert Mikrobiom-Diversität", target: 1 },
      { id: 'strength', title: "Krafttraining 2-3x/Woche", info: "Hält Muskelmasse, Insulinsensitivität", target: 2 }
    ];
    const safeGet = (key, defaultValue) => {
      try {
        const item = storage.getItem(key);
        return (item !== null && item !== undefined) ? JSON.parse(item) : defaultValue;
      } catch (error) {
        console.error(`Error reading/parsing item "${key}":`, error);
        try { storage.removeItem(key); } catch (removeError) { console.error(`Failed to remove corrupted item "${key}":`, removeError); }
        return defaultValue;
      }
    };
    const formatDate = (date = new Date()) => date.toISOString().split('T')[0];
    const today = formatDate();
    const getDateForDisplay = (date = today) => {
      try {
          const d = new Date(date);
          if (isNaN(d.getTime())) return "Ungültiges Datum";
          return d.toLocaleDateString('de-DE', { weekday: 'short', day: '2-digit', month: '2-digit', year: 'numeric' });
      } catch (e) { console.error(`Error formatting date: ${date}`, e); return "Datumsfehler"; }
    };

    // --- ALARM CLOCK HTML ---
    // Store the HTML content from ALARMUHR.txt in a variable
    // Note: Using template literals for multiline string. Ensure no backticks ` within the HTML itself.
    const alarmClockHtml = `
<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wecker 3D - Mit Audio</title>
    <script src="https://cdn.tailwindcss.com"><\/script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"><\/script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"><\/script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"><\/script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">


    <style>
        /* Basic styles and adjustments */
        html, body, #root {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; /* Prevent scrollbars within iframe */
        }
        body {
            background: linear-gradient(135deg, #1f2937, #111827);
            color: #e5e7eb;
            font-family: 'Inter', sans-serif;
        }
        input[type='number']::-webkit-inner-spin-button,
        input[type='number']::-webkit-outer-spin-button {
          -webkit-appearance: none;
          margin: 0;
        }
        input[type='number'] { -moz-appearance: textfield; }
        .text-glow { text-shadow: 0 0 8px rgba(59, 130, 246, 0.5), 0 0 12px rgba(59, 130, 246, 0.3); }
        .time-glow { text-shadow: 0 0 10px rgba(34, 211, 238, 0.6), 0 0 15px rgba(34, 211, 238, 0.4); }
        .btn-3d {
            transition: all 0.15s ease-in-out;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2), inset 0 -2px 3px rgba(0, 0, 0, 0.15);
            border-radius: 0.5rem;
            font-weight: 600;
            padding: 0.75rem 1rem;
        }
        .btn-3d:active {
            transform: translateY(2px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2), inset 0 -1px 2px rgba(0, 0, 0, 0.15);
        }
        .btn-3d:disabled {
            transform: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            cursor: not-allowed;
            opacity: 0.7;
        }
        .font-roboto-mono { font-family: 'Roboto Mono', monospace; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Main Alarm Clock Component
        function AlarmClock() {
          // State variables
          const [currentTime, setCurrentTime] = useState(new Date());
          const [alarmTime, setAlarmTime] = useState('');
          const [isAlarmSet, setIsAlarmSet] = useState(false);
          const [isRinging, setIsRinging] = useState(false);
          const [hour, setHour] = useState('07');
          const [minute, setMinute] = useState('00');
          const [alarmTriggeredForMinute, setAlarmTriggeredForMinute] = useState(false);
          const SNOOZE_DURATION = 9;

          // --- AUDIO REFS AND LOGIC ---
          const audioRef = useRef(null); // Ref for the Audio element
          const lastCheckedMinuteRef = useRef(null);

          // --- NEW: useEffect to initialize the Audio object ---
          useEffect(() => {
            console.log("Attempting to initialize Audio object...");
            // WICHTIG: Pfad zur Audiodatei anpassen! / IMPORTANT: Adjust the path to your audio file!
            // Ersetzen Sie 'alarm.mp3' mit dem korrekten Pfad oder der URL zu Ihrer Sounddatei.
            // Replace 'alarm.mp3' with the correct path or URL to your sound file.
            const audioFile = 'https://cdn.pixabay.com/audio/2023/02/16/audio_14fa915418.mp3'; // <-- Example URL, replace if needed

            try {
              // Create the Audio object only once
              if (!audioRef.current) {
                audioRef.current = new Audio(audioFile);
                audioRef.current.loop = true; // Optional: Loop the alarm sound
                console.log("Audio object created for:", audioFile);
              }
            } catch (error) {
              console.error("Error creating Audio object:", error);
              alert("Fehler beim Laden der Alarm-Audiodatei. Sound wird nicht verfügbar sein.");
            }

            // Cleanup function: Stop audio when component unmounts
            return () => {
              if (audioRef.current) {
                console.log("Cleaning up audio object.");
                audioRef.current.pause();
                audioRef.current = null; // Release the object
              }
            };
          }, []); // Empty array: Run only on first render

          // --- Helper function to stop and reset audio ---
          const stopAndResetAudio = () => {
              if (audioRef.current) {
                  console.log("Pausing and resetting audio.");
                  audioRef.current.pause();
                  audioRef.current.currentTime = 0; // Rewind to the beginning
              }
          }
          // --- END AUDIO LOGIC ---


          // Effect to load alarm state from localStorage
          useEffect(() => {
            console.log("Loading state from localStorage...");
            const storedAlarmTime = localStorage.getItem('alarmClockTime');
            const storedIsAlarmSet = localStorage.getItem('alarmClockIsSet');

            if (storedAlarmTime) {
              console.log(\`Loaded alarmTime: \${storedAlarmTime}\`);
              setAlarmTime(storedAlarmTime);
              const [storedHour, storedMinute] = storedAlarmTime.split(':');
              setHour(storedHour || '07');
              setMinute(storedMinute || '00');
            } else {
              console.log("No alarmTime found in localStorage.");
            }
            if (storedIsAlarmSet === 'true') {
              console.log("Loaded isAlarmSet: true");
              setIsAlarmSet(true);
            } else {
               console.log("No isAlarmSet found or it's false.");
            }
            setAlarmTriggeredForMinute(false);
            lastCheckedMinuteRef.current = new Date().getMinutes();
          }, []);

          // Effect to save alarm state to localStorage
          useEffect(() => {
            if (isAlarmSet && alarmTime) {
              console.log(\`Saving state: alarmTime=\${alarmTime}, isAlarmSet=true\`);
              localStorage.setItem('alarmClockTime', alarmTime);
              localStorage.setItem('alarmClockIsSet', 'true');
            } else {
              if (localStorage.getItem('alarmClockTime') || localStorage.getItem('alarmClockIsSet')) {
                  console.log("Clearing alarm state from localStorage.");
                  localStorage.removeItem('alarmClockTime');
                  localStorage.removeItem('alarmClockIsSet');
              }
            }
          }, [alarmTime, isAlarmSet]);

          // Effect to update current time
          useEffect(() => {
            const timerId = setInterval(() => {
              setCurrentTime(new Date());
            }, 1000);
            return () => clearInterval(timerId);
          }, []);

          // REVISED Effect to check if the alarm should ring
          useEffect(() => {
            const now = currentTime;
            const currentMinuteValue = now.getMinutes();
            const currentHour = String(now.getHours()).padStart(2, '0');
            const currentMinuteString = String(currentMinuteValue).padStart(2, '0');
            const currentTimeFormatted = \`\${currentHour}:\${currentMinuteString}\`;

            if (isAlarmSet) {
                 console.log(\`Tick: Current=\${currentTimeFormatted}, Alarm=\${alarmTime}, Set=\${isAlarmSet}, Ringing=\${isRinging}, TriggeredFlag=\${alarmTriggeredForMinute}, LastCheckedMin=\${lastCheckedMinuteRef.current}, CurrentMin=\${currentMinuteValue}\`);
            }

            // Reset the trigger flag only when the actual minute changes
            if (currentMinuteValue !== lastCheckedMinuteRef.current) {
                console.log(\`Minute changed from \${lastCheckedMinuteRef.current} to \${currentMinuteValue}. Resetting trigger flag.\`);
                setAlarmTriggeredForMinute(false);
                lastCheckedMinuteRef.current = currentMinuteValue;
            }

            // Conditions to check for ringing
            if (isAlarmSet && !isRinging && alarmTime === currentTimeFormatted && !alarmTriggeredForMinute) {
                console.log(\`%cALARM TRIGGERED! Time: \${currentTimeFormatted}\`, 'color: red; font-weight: bold;');
                setIsRinging(true);
                setAlarmTriggeredForMinute(true);

                // --- AUDIO PLAY ---
                if (audioRef.current) {
                    console.log("Attempting to play audio...");
                    audioRef.current.play()
                        .then(() => { console.log("Audio playback started successfully."); })
                        .catch(err => {
                            console.error("Audio Playback Error:", err);
                            alert("Audiowiedergabe blockiert. Klicken Sie möglicherweise zuerst auf 'Alarm stellen' oder eine andere Schaltfläche, um Audio zu aktivieren.");
                        });
                } else {
                    console.warn("Audio object not available, cannot play sound.");
                    alert("Alarmton kann nicht abgespielt werden (Audio-Objekt nicht verfügbar).");
                }
                // --- END AUDIO PLAY ---
            }

            // Reset flag if alarm is cleared
            if (!isAlarmSet && alarmTriggeredForMinute) {
                 console.log("Alarm is not set, ensuring trigger flag is false.");
                 setAlarmTriggeredForMinute(false);
            }

          }, [currentTime, alarmTime, isAlarmSet, isRinging, alarmTriggeredForMinute]);


          // --- HANDLERS ---
          const handleSetAlarm = () => {
            const formattedHour = String(hour).padStart(2, '0');
            const formattedMinute = String(minute).padStart(2, '0');
            const newAlarmTime = \`\${formattedHour}:\${formattedMinute}\`;
            setAlarmTime(newAlarmTime);
            setIsAlarmSet(true);
            setIsRinging(false);
            setAlarmTriggeredForMinute(false);
            lastCheckedMinuteRef.current = new Date().getMinutes();
            console.log(\`Alarm set for: \${newAlarmTime}\`);
          };

          const handleClearAlarm = () => {
            setAlarmTime('');
            setIsAlarmSet(false);
            setIsRinging(false);
            setAlarmTriggeredForMinute(false);
            stopAndResetAudio(); // Stop audio
            console.log("Alarm cleared");
          };

          const handleStopRinging = () => {
            setIsRinging(false);
            stopAndResetAudio(); // Stop audio
            handleClearAlarm(); // Current behavior: Clear the alarm after stopping
            console.log("Alarm stopped and cleared");
          };

          const handleSnooze = () => {
              setIsRinging(false);
              stopAndResetAudio(); // Stop audio
              const now = new Date();
              const snoozeTime = new Date(now.getTime() + SNOOZE_DURATION * 60000);
              const snoozeHour = String(snoozeTime.getHours()).padStart(2, '0');
              const snoozeMinute = String(snoozeTime.getMinutes()).padStart(2, '0');
              const newAlarmTime = \`\${snoozeHour}:\${snoozeMinute}\`;
              setAlarmTime(newAlarmTime);
              setHour(snoozeHour);
              setMinute(snoozeMinute);
              setIsAlarmSet(true);
              setAlarmTriggeredForMinute(false);
              lastCheckedMinuteRef.current = snoozeTime.getMinutes();
              console.log(\`Alarm snoozed until: \${newAlarmTime}\`);
          };

          // Formats time
          const formatTime = (date) => {
             if (!(date instanceof Date) || isNaN(date)) { return '--:--:--'; }
             return date.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
          };

          // Input Handlers
          const handleHourChange = (e) => { let value = e.target.value; if (value === '') { setHour(''); return; } let numValue = parseInt(value, 10); if (isNaN(numValue)) numValue = 0; numValue = Math.max(0, Math.min(23, numValue)); setHour(String(numValue).padStart(2, '0')); };
          const handleHourBlur = (e) => { if (e.target.value === '') { setHour('00'); } };
          const handleMinuteChange = (e) => { let value = e.target.value; if (value === '') { setMinute(''); return; } let numValue = parseInt(value, 10); if (isNaN(numValue)) numValue = 0; numValue = Math.max(0, Math.min(59, numValue)); setMinute(String(numValue).padStart(2, '0')); };
          const handleMinuteBlur = (e) => { if (e.target.value === '') { setMinute('00'); } };
          // --- END HANDLERS ---


          // --- JSX ---
          return (
            <div className="min-h-full flex items-center justify-center p-4 font-inter">
              <div className="bg-gradient-to-br from-gray-700 to-gray-800 p-6 sm:p-8 rounded-2xl shadow-2xl w-full max-w-md mx-auto border border-gray-600/50 relative overflow-hidden">
                <h1 className="text-3xl sm:text-4xl font-bold text-center text-blue-300 mb-6 sm:mb-8 text-glow">Digital Wecker</h1>
                <div className="text-5xl sm:text-6xl font-roboto-mono text-center text-cyan-300 mb-8 sm:mb-10 p-4 bg-black/40 rounded-lg shadow-inner shadow-black/50 time-glow tracking-widest">{formatTime(currentTime)}</div>
                {isRinging && (<div className="mb-6 p-4 bg-gradient-to-r from-red-500 via-pink-500 to-red-500 border-2 border-red-300 text-white rounded-lg shadow-lg animate-pulse"><p className="font-bold text-center text-xl sm:text-2xl mb-4">ALARM!</p><div className="flex space-x-3"><button onClick={handleSnooze} className="btn-3d flex-1 bg-gradient-to-r from-yellow-500 to-orange-500 hover:from-yellow-600 hover:to-orange-600 text-white">Schlummern ({SNOOZE_DURATION} Min)</button><button onClick={handleStopRinging} className="btn-3d flex-1 bg-gradient-to-r from-red-600 to-pink-600 hover:from-red-700 hover:to-pink-700 text-white">Stoppen & Löschen</button></div></div>)}
                {!isRinging && (<div className="mb-4"><div className="flex justify-center items-center space-x-3 mb-6"><div className="text-center"><label htmlFor="hour" className="block text-sm font-medium text-gray-400 mb-1">Stunde</label><input type="number" id="hour" value={hour} onChange={handleHourChange} onBlur={handleHourBlur} className="block w-20 sm:w-24 px-3 py-3 bg-gray-800/70 border border-gray-600 rounded-md shadow-inner text-gray-100 focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 text-2xl sm:text-3xl text-center appearance-none font-roboto-mono" placeholder="HH" min="0" max="23"/></div><span className="text-3xl sm:text-4xl text-gray-500 pt-6 font-roboto-mono">:</span><div className="text-center"><label htmlFor="minute" className="block text-sm font-medium text-gray-400 mb-1">Minute</label><input type="number" id="minute" value={minute} onChange={handleMinuteChange} onBlur={handleMinuteBlur} className="block w-20 sm:w-24 px-3 py-3 bg-gray-800/70 border border-gray-600 rounded-md shadow-inner text-gray-100 focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 text-2xl sm:text-3xl text-center appearance-none font-roboto-mono" placeholder="MM" min="0" max="59"/></div></div><div className="space-y-3"><button onClick={handleSetAlarm} className={\`btn-3d w-full text-white \${ isAlarmSet ? 'bg-gray-500 cursor-not-allowed' : 'bg-gradient-to-r from-blue-500 to-cyan-500 hover:from-blue-600 hover:to-cyan-600' }\`} disabled={isAlarmSet}>{isAlarmSet ? \`Alarm aktiv: \${alarmTime}\` : 'Alarm stellen'}</button>{isAlarmSet && (<button onClick={handleClearAlarm} className="btn-3d w-full bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-600 hover:to-orange-600 text-white">Alarm löschen</button>)}</div></div>)}
                <div className="text-center text-xs text-gray-500 mt-6">{isAlarmSet ? (isRinging ? \`Alarm klingelt für \${alarmTime}\` : \`Alarm gestellt für \${alarmTime}\`) : "Kein Alarm aktiv"}</div>
              </div>
            </div>
          );
        }
        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<AlarmClock />);
    <\/script>
</body>
</html>
`;
    // --- END ALARM CLOCK HTML ---


    // --- Reusable Components ---
    const ProgressBar = ({ value, max, color = 'bg-primary', showPercentage = false, height = "h-4" }) => {
      const numericValue = typeof value === 'number' && !isNaN(value) ? value : 0;
      const numericMax = typeof max === 'number' && !isNaN(max) && max > 0 ? max : 0;
      const perc = numericMax > 0 ? Math.min(100, Math.max(0, numericValue / numericMax * 100)) : 0;
      let barColor = color;
      if (!color.startsWith('bg-')) { // Auto-color based on percentage if no specific bg-color provided
        if (perc > 100) barColor = 'bg-danger';
        else if (perc >= 100) barColor = 'bg-success';
        else if (perc > 80) barColor = 'bg-warning';
        else if (perc > 50) barColor = 'bg-info';
        else barColor = 'bg-blue-400';
      }
      return (
        <div className={`w-full bg-gray-300 dark:bg-gray-700 rounded-full ${height} overflow-hidden shadow-inner mt-1 mb-2`}>
          <div className={`${barColor} ${height} rounded-full transition-all duration-500 flex items-center justify-end`} style={{ width: `${Math.min(100, perc)}%` }}>
            {showPercentage && perc > 15 && <span className="px-2 text-xs text-white font-semibold">{Math.round(perc)}%</span>}
          </div>
        </div>
      );
    };
    const Tabs = ({ active, setActive }) => {
      const { isDark } = useContext(ThemeContext);
      return (
        <div className="flex flex-wrap justify-center mb-8 gap-2">
          {Object.values(TABS).map(tab => (
            <button key={tab} onClick={() => setActive(tab)} className={`flex items-center gap-2 px-4 py-2 rounded-full font-semibold shadow transition-transform duration-150 ${active === tab ? 'bg-gradient-to-r from-pink-500 to-purple-600 text-white scale-105 shadow-lg' : isDark ? 'bg-gray-800 text-white hover:bg-gray-700 hover:scale-105' : 'bg-white text-gray-700 hover:bg-gray-100 hover:scale-105'}`}>
              {tab === 'dashboard' && <i className="fas fa-chart-pie"/>} {tab === 'food' && <i className="fas fa-utensils"/>} {tab === 'exercise' && <i className="fas fa-dumbbell"/>} {tab === 'goals' && <i className="fas fa-bullseye"/>} {tab === 'aging' && <i className="fas fa-leaf"/>} {tab === 'stats' && <i className="fas fa-chart-line"/>} {TAB_LABELS[tab]}
            </button>
          ))}
        </div>
      );
    };
    const Card = ({ title, color, children, className = "" }) => {
      const { isDark } = useContext(ThemeContext);
      return <div className={`p-5 rounded-2xl shadow-lg ${isDark ? 'bg-gray-800 text-white' : 'bg-white bg-opacity-90'} backdrop-blur-md border-t-4 card-transition ${className}`} style={{ borderColor: color }}><h3 className="font-semibold text-lg mb-4" style={{ color }}>{title}</h3>{children}</div>;
    };
    const LogList = ({ items, onDelete, renderItem }) => {
      const { isDark } = useContext(ThemeContext);
      return (
        items.length === 0
        ? <p className={`italic ${isDark ? 'text-gray-400' : 'text-gray-500'}`}>Keine Einträge für heute</p>
        : <ul className="space-y-3 max-h-96 overflow-y-auto pr-1">
            {items.map(i => (
              <li key={i.id} className={`flex justify-between items-center pb-2 border-b ${isDark ? 'border-gray-700' : 'border-gray-200'} last:border-0`}>
                <div className="flex-1 mr-2 overflow-hidden">{renderItem(i)}</div>
                <button title="Löschen" onClick={() => onDelete(i.id)} className="text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-100 dark:hover:bg-red-900 ml-2 flex-shrink-0"><i className="fas fa-trash"/></button>
              </li>
            ))}
          </ul>
      );
    };

    // --- Feature Components ---
    const WaterTracker = ({ waterData, setWaterState, goal }) => {
        const addWater = (amount) => {
            if (typeof amount !== 'number' || amount <= 0) return;
            const newItem = { id: crypto.randomUUID(), amount, timestamp: new Date().toISOString(), date: today };
            setWaterState(prev => [...prev, newItem]);
        };
        const deleteWater = (id) => { setWaterState(prev => prev.filter(w => w.id !== id)); };
        const todayWater = useMemo(() => waterData.filter(w => w.date === today), [waterData, today]);
        const totalWater = todayWater.reduce((sum, item) => sum + (item.amount || 0), 0);
        const percentage = goal > 0 ? Math.min(100, Math.round((totalWater / goal) * 100)) : 0;
        return (
            <div className="flex flex-col gap-3">
                <div className="flex items-end gap-2"><div className="flex-1"><div className="flex justify-between mb-1 text-sm"><span>{totalWater} ml</span><span>{goal} ml</span></div><div className="h-8 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden relative"><div className="h-full bg-blue-400 dark:bg-blue-600 transition-all duration-500 flex items-center justify-center" style={{ width: `${percentage}%` }}>{percentage > 15 && <span className="text-xs text-white font-semibold">{percentage}%</span>}</div><div className="absolute inset-0 pointer-events-none">{Array.from({ length: Math.max(1, Math.floor(goal / 500)) }).map((_, i) => (<div key={i} className="absolute top-0 bottom-0 border-r border-gray-300 dark:border-gray-600 opacity-50" style={{ left: `${((i + 1) * 500 / goal) * 100}%`, width: '1px' }}></div>))}</div></div></div><i className="fas fa-tint text-blue-500 text-2xl ml-1"></i></div>
                <div className="flex flex-wrap gap-2">{[200, 350, 500].map(amount => (<button key={amount} onClick={() => addWater(amount)} className="flex-1 min-w-[calc(33%-0.5rem)] py-2 px-3 rounded-lg bg-blue-100 hover:bg-blue-200 dark:bg-blue-900 dark:hover:bg-blue-800 font-medium text-blue-700 dark:text-blue-300 transition shadow-sm">+{amount}ml</button>))}</div>
                {todayWater.length > 0 && (<div className="mt-2 max-h-32 overflow-y-auto text-sm pr-1"><h4 className="font-semibold mb-1">Heute getrunken:</h4><ul className="space-y-1">{[...todayWater].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)).map((w) => (<li key={w.id} className="flex justify-between items-center"><span>{new Date(w.timestamp).toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' })} - {w.amount}ml</span><button onClick={() => deleteWater(w.id)} className="text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-100 dark:hover:bg-red-900 text-xs" aria-label="Wasser Eintrag löschen"><i className="fas fa-times"></i></button></li>))}</ul></div>)}
            </div>
        );
    };
    const WeightTracker = ({ weights, setWeights, targetWeight }) => {
        const [newWeight, setNewWeight] = useState('');
        const { isDark } = useContext(ThemeContext);
        const chartRef = useRef(null);
        const chartInstance = useRef(null);
        const addWeight = () => {
            if (!newWeight || isNaN(parseFloat(newWeight))) { alert("Bitte geben Sie eine gültige Zahl für das Gewicht ein."); return; }
            const weightVal = parseFloat(newWeight);
            if (weightVal < 20 || weightVal > 400) { alert("Bitte geben Sie ein realistisches Gewicht ein (20-400 kg)."); return; }
            setWeights(prev => {
                const existingIndex = prev.findIndex(w => w.date === today);
                if (existingIndex !== -1) { const updatedWeights = [...prev]; updatedWeights[existingIndex] = { ...updatedWeights[existingIndex], weight: weightVal }; return updatedWeights; }
                else { return [...prev, { id: crypto.randomUUID(), date: today, weight: weightVal }]; }
            });
            setNewWeight('');
        };
        const deleteWeight = (id) => setWeights(prev => prev.filter(w => w.id !== id));
        const sortedWeightsForList = useMemo(() => [...weights].sort((a, b) => new Date(b.date) - new Date(a.date)), [weights]);
        const currentWeight = sortedWeightsForList.length > 0 ? sortedWeightsForList[0].weight : null;
        const weightDiff = currentWeight !== null && typeof targetWeight === 'number' ? (currentWeight - targetWeight).toFixed(1) : null;
        useEffect(() => { // Chart logic
            if (weights.length < 1 || !chartRef.current) { if (chartInstance.current) { chartInstance.current.destroy(); chartInstance.current = null; } return; }
            const data = [...weights].sort((a, b) => new Date(a.date) - new Date(b.date)).slice(-30);
            const labels = data.map(w => getDateForDisplay(w.date));
            const weightData = data.map(w => w.weight);
            if (chartInstance.current) chartInstance.current.destroy();
            const ctx = chartRef.current.getContext('2d');
            chartInstance.current = new Chart(ctx, { type: 'line', data: { labels, datasets: [{ label: 'Gewicht (kg)', data: weightData, borderColor: '#8B5CF6', backgroundColor: 'rgba(139, 92, 246, 0.1)', tension: 0.3, fill: true, pointRadius: 3, pointBackgroundColor: '#8B5CF6' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { backgroundColor: isDark ? '#374151' : 'rgba(255, 255, 255, 0.9)', titleColor: isDark ? '#fff' : '#000', bodyColor: isDark ? '#fff' : '#000', borderColor: '#8B5CF6', borderWidth: 1, padding: 10, displayColors: false } }, scales: { y: { beginAtZero: false, grid: { color: isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)' }, ticks: { color: isDark ? '#fff' : '#000' } }, x: { grid: { display: false }, ticks: { color: isDark ? '#fff' : '#000', maxRotation: 45, minRotation: 45, autoSkip: true, maxTicksLimit: 10 } } } } });
            return () => { if (chartInstance.current) { chartInstance.current.destroy(); chartInstance.current = null; } };
        }, [weights, isDark, targetWeight]);
        return ( // JSX for WeightTracker
            <div className="space-y-4">
                <div className="flex gap-3 items-start"><div className="flex-1"><input type="number" value={newWeight} onChange={e => setNewWeight(e.target.value)} placeholder={`Heute (${today})`} step="0.1" min="20" max="400" className="w-full p-2 rounded border border-gray-300 dark:border-gray-700 dark:bg-gray-700 dark:text-white text-base focus:ring-2 focus:ring-purple-500 focus:border-transparent" aria-label="Gewicht in kg eingeben"/><p className="text-xs text-gray-500 dark:text-gray-400 mt-1">Gewicht in kg</p></div><button onClick={addWeight} className="px-4 py-2 rounded-lg bg-purple-500 hover:bg-purple-600 text-white font-semibold transition shadow-sm h-[42px]" aria-label="Gewicht speichern">Speichern</button></div>
                {currentWeight !== null && typeof targetWeight === 'number' && <div className="p-3 rounded-lg bg-gray-100 dark:bg-gray-700 flex items-center justify-between text-sm"><div><p>Aktuell: <span className="font-bold">{currentWeight} kg</span> ({getDateForDisplay(sortedWeightsForList[0].date)})</p><p>Ziel: <span className="font-bold">{targetWeight} kg</span></p></div>{weightDiff !== null && <div className={`text-lg font-bold ${weightDiff > 0 ? 'text-orange-500' : 'text-green-500'}`}>{weightDiff > 0 ? `+${weightDiff}` : weightDiff} kg</div>}</div>}
                {weights.length > 0 && <div className="h-48 w-full mt-4">{weights.length < 2 && <p className="text-center text-sm text-gray-500 dark:text-gray-400">Mehr Datenpunkte benötigt für Trend.</p>}<canvas ref={chartRef}></canvas></div>}
                {sortedWeightsForList.length > 0 && <div className="mt-2 max-h-64 overflow-y-auto pr-1"><h4 className="font-semibold mb-2">Gewichtsverlauf:</h4><div className="divide-y divide-gray-200 dark:divide-gray-700">{sortedWeightsForList.map(w => <div key={w.id} className="flex justify-between items-center py-2 text-sm"><div><span className="font-medium">{getDateForDisplay(w.date)}</span><span className="ml-4">{w.weight} kg</span></div><button onClick={() => deleteWeight(w.id)} className="text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-100 dark:hover:bg-red-900" aria-label={`Gewichtseintrag vom ${getDateForDisplay(w.date)} löschen`}><i className="fas fa-times"></i></button></div>)}</div></div>}
                {weights.length === 0 && <p className="text-center text-sm text-gray-500 dark:text-gray-400">Noch keine Gewichtseinträge vorhanden.</p>}
            </div>
        );
    };
    const LongevityTracker = ({ agingData, setAgingData }) => {
        const { isDark } = useContext(ThemeContext);
        const toggleItem = (id) => {
            setAgingData(prev => {
                const index = prev.findIndex(i => i.id === id && i.date === today);
                const itemDefinition = longevityItems.find(i => i.id === id);
                if (!itemDefinition) return prev;
                if (index >= 0) { // Item exists for today
                    const updatedItem = { ...prev[index] };
                    updatedItem.count = (updatedItem.count >= itemDefinition.target) ? 0 : updatedItem.count + 1;
                    const newData = [...prev]; newData[index] = updatedItem; return newData;
                } else { // Add new item for today
                    return [...prev, { id, count: 1, target: itemDefinition.target, date: today }];
                }
            });
        };
        const todayItems = useMemo(() => agingData.filter(i => i.date === today), [agingData, today]);
        const score = useMemo(() => { // Calculate score
            const totalPossiblePoints = longevityItems.reduce((sum, item) => sum + item.target, 0);
            if (totalPossiblePoints === 0) return 0;
            const achievedPoints = todayItems.reduce((sum, userItem) => {
                const definition = longevityItems.find(i => i.id === userItem.id);
                return sum + (definition && definition.target > 0 ? Math.min(userItem.count, definition.target) : 0);
            }, 0);
            return Math.round((achievedPoints / totalPossiblePoints) * 100);
        }, [todayItems]);
        const dailyTip = useMemo(() => { // Daily tip logic
            const tips = ["Nahrungsvielfalt fördert ein gesundes Mikrobiom. Ziele auf 30+ verschiedene Pflanzen pro Woche.", "Kälteexposition (z.B. kalte Duschen) kann braunes Fett aktivieren.", "Ausreichend Vitamin D ist wichtig für die Immunfunktion.", "Soziale Bindungen sind ein starker Prädiktor für Langlebigkeit.", "Reduziere verarbeitete Lebensmittel und Zucker."];
            const dayOfYear = Math.floor((new Date() - new Date(new Date().getFullYear(), 0, 0)) / 86400000);
            return tips[dayOfYear % tips.length];
        }, []);
        return ( // JSX for LongevityTracker
            <div className="space-y-6">
                <div className="flex flex-col sm:flex-row gap-6 items-center justify-between mb-6"><div className="text-center sm:text-left"><h2 className="text-2xl font-bold text-purple-700 dark:text-purple-400">Langlebigkeits-Score</h2><p className="text-gray-600 dark:text-gray-300">Deine täglichen Anti-Aging Aktivitäten</p></div><div className="relative w-32 h-32 flex-shrink-0"><svg className="absolute inset-0 w-full h-full" viewBox="0 0 100 100"><circle cx="50" cy="50" r="45" fill="none" stroke="#E2E8F0" strokeWidth="10" className="dark:stroke-gray-700"/><circle cx="50" cy="50" r="45" fill="none" stroke={score >= 80 ? "#22C55E" : score >= 50 ? "#F59E0B" : "#8B5CF6"} strokeWidth="10" strokeDasharray="282.7" strokeDashoffset={282.7 - (282.7 * score / 100)} strokeLinecap="round" transform="rotate(-90 50 50)" style={{ transition: 'stroke-dashoffset 0.5s ease-in-out' }}/></svg><div className="absolute inset-0 flex items-center justify-center"><div className="text-center"><span className="text-3xl font-bold">{score}%</span></div></div></div></div>
                <div className="grid sm:grid-cols-2 gap-4">{longevityItems.map(item => { const userItem = todayItems.find(i => i.id === item.id) || { count: 0, target: item.target }; const isComplete = userItem.count >= item.target; return (<div key={item.id} className={`p-4 rounded-lg border-l-4 ${isComplete ? 'border-green-500 bg-green-50 dark:bg-green-900/20' : 'border-purple-400 bg-purple-50 dark:bg-purple-900/20'} cursor-pointer hover:shadow-md transition-all duration-200 group`} onClick={() => toggleItem(item.id)} role="button" tabIndex="0" onKeyPress={(e) => { if (e.key === 'Enter' || e.key === ' ') toggleItem(item.id); }}><div className="flex items-start gap-3"><div className={`w-6 h-6 flex-shrink-0 rounded-full flex items-center justify-center mt-0.5 border ${isComplete ? 'bg-green-500 text-white border-green-600' : 'bg-white dark:bg-gray-800 border-purple-400 group-hover:bg-purple-100 dark:group-hover:bg-purple-800'} transition-colors duration-200`}>{isComplete && <i className="fas fa-check text-xs"></i>}{!isComplete && userItem.count > 0 && <span className="text-xs font-bold text-purple-600 dark:text-purple-300">{userItem.count}</span>}</div><div className="flex-1"><div className="flex justify-between items-center"><p className="font-semibold">{item.title}</p><span className={`text-sm font-medium ${isComplete ? 'text-green-600 dark:text-green-400' : 'text-purple-600 dark:text-purple-400'}`}>{userItem.count}/{item.target}</span></div><p className={`text-sm ${isDark ? 'text-gray-300' : 'text-gray-600'}`}>{item.info}</p></div></div></div>); })}</div>
                <div className="p-4 rounded-lg bg-blue-50 dark:bg-blue-900/20 border-l-4 border-blue-500"><h3 className="font-semibold text-blue-700 dark:text-blue-400 flex items-center gap-2"><i className="fas fa-lightbulb"></i>Langlebigkeits-Tipp des Tages</h3><p className="mt-2 text-gray-700 dark:text-gray-300">{dailyTip}</p></div>
            </div>
        );
    };
    const StatsView = ({ food, exercise, water, weights, agingData, goals }) => {
        const { isDark } = useContext(ThemeContext);
        const activityChartRef = useRef(null); const activityChartInstance = useRef(null);
        const weightChartRef = useRef(null); const weightChartInstance = useRef(null);
        const [currentStreak, longestStreak] = useMemo(() => { // Streak calculation
            const activityDays = new Set();
            [...food, ...exercise, ...water, ...agingData].forEach(item => { if (item.date && typeof item.date === 'string' && !isNaN(new Date(item.date))) activityDays.add(item.date); });
            const sortedDays = Array.from(activityDays).sort((a, b) => new Date(a) - new Date(b));
            if (sortedDays.length === 0) return [0, 0];
            let current = 0, longest = 0, streakCounter = 0; const todayStr = formatDate(new Date());
            for (let i = 0; i < sortedDays.length; i++) { if (i > 0) { const curr = new Date(sortedDays[i]); const prev = new Date(sortedDays[i - 1]); const diffDays = Math.round((curr - prev) / 86400000); if (diffDays === 1) streakCounter++; else { longest = Math.max(longest, streakCounter); streakCounter = 1; } } else streakCounter = 1; longest = Math.max(longest, streakCounter); }
            if (sortedDays.includes(todayStr)) { current = 1; let dayIndex = sortedDays.indexOf(todayStr); while (dayIndex > 0) { const curr = new Date(sortedDays[dayIndex]); const prev = new Date(sortedDays[dayIndex - 1]); if (Math.round((curr - prev) / 86400000) === 1) { current++; dayIndex--; } else break; } }
            return [current, longest];
        }, [food, exercise, water, agingData]);
        useEffect(() => { // Activity Chart (7 days)
            if (!activityChartRef.current) return;
            const dates = Array.from({length: 7}, (_, i) => { const d = new Date(); d.setDate(d.getDate() - (6 - i)); return formatDate(d); });
            const getCount = (arr, date) => arr.filter(item => item.date === date).length;
            const getWaterAmount = (arr, date) => arr.filter(item => item.date === date).reduce((sum, w) => sum + w.amount, 0);
            const foodCounts = dates.map(date => getCount(food, date));
            const exerciseCounts = dates.map(date => getCount(exercise, date));
            const waterAmounts = dates.map(date => (getWaterAmount(water, date) / 1000).toFixed(1));
            const longevityScores = dates.map(date => { const dayItems = agingData.filter(i => i.date === date); const totalTargets = longevityItems.reduce((sum, item) => sum + item.target, 0); if (totalTargets === 0) return 0; const achieved = dayItems.reduce((sum, item) => { const definition = longevityItems.find(i => i.id === item.id); return sum + (definition ? Math.min(item.count, definition.target) : 0); }, 0); return Math.round((achieved / totalTargets) * 100); });
            const displayDates = dates.map(date => new Date(date).toLocaleDateString('de-DE', { weekday: 'short' }));
            if (activityChartInstance.current) activityChartInstance.current.destroy();
            const ctx = activityChartRef.current.getContext('2d');
            activityChartInstance.current = new Chart(ctx, { type: 'bar', data: { labels: displayDates, datasets: [{ label: 'Mahlzeiten', data: foodCounts, backgroundColor: '#8B5CF6', borderRadius: 4, order: 1 }, { label: 'Übungen', data: exerciseCounts, backgroundColor: '#22C55E', borderRadius: 4, order: 2 }, { label: 'Wasser (L)', type: 'line', data: waterAmounts, borderColor: '#3B82F6', backgroundColor: 'rgba(59, 130, 246, 0.1)', yAxisID: 'yWater', tension: 0.3, fill: false, pointRadius: 3, order: 0 }, { label: 'Langlebigkeit (%)', type: 'line', data: longevityScores, borderColor: '#F59E0B', backgroundColor: 'rgba(245, 158, 11, 0.1)', yAxisID: 'yScore', tension: 0.3, fill: false, pointRadius: 3, order: 0 }] }, options: { responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false }, plugins: { legend: { position: 'bottom', labels: { color: isDark ? '#fff' : '#000', padding: 15 } }, tooltip: { backgroundColor: isDark ? '#374151' : 'rgba(255, 255, 255, 0.9)', titleColor: isDark ? '#fff' : '#000', bodyColor: isDark ? '#fff' : '#000', borderColor: '#8B5CF6', borderWidth: 1, padding: 10, displayColors: true } }, scales: { y: { beginAtZero: true, position: 'left', grid: { color: isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)' }, ticks: { color: isDark ? '#fff' : '#000', stepSize: 1 }, title: { display: true, text: 'Anzahl Aktivitäten', color: isDark ? '#fff' : '#000' } }, yWater: { beginAtZero: true, position: 'right', grid: { drawOnChartArea: false }, ticks: { color: '#3B82F6' }, title: { display: true, text: 'Wasser (L)', color: '#3B82F6' } }, yScore: { beginAtZero: true, max: 100, position: 'right', grid: { drawOnChartArea: false }, ticks: { color: '#F59E0B' }, title: { display: true, text: 'Langlebigkeit (%)', color: '#F59E0B' }, offset: true }, x: { grid: { display: false }, ticks: { color: isDark ? '#fff' : '#000' } } } } });
            return () => { if (activityChartInstance.current) { activityChartInstance.current.destroy(); activityChartInstance.current = null; } };
        }, [food, exercise, water, agingData, isDark]);
        useEffect(() => { // Weight Chart (All time)
            if (weights.length < 1 || !weightChartRef.current) { if (weightChartInstance.current) { weightChartInstance.current.destroy(); weightChartInstance.current = null; } return; }
            const data = [...weights].sort((a, b) => new Date(a.date) - new Date(b.date));
            const labels = data.map(w => getDateForDisplay(w.date));
            const weightData = data.map(w => w.weight);
            const targetLine = Array(data.length).fill(goals.targetWeight);
            if (weightChartInstance.current) weightChartInstance.current.destroy();
            const ctx = weightChartRef.current.getContext('2d');
            weightChartInstance.current = new Chart(ctx, { type: 'line', data: { labels, datasets: [{ label: 'Gewicht (kg)', data: weightData, borderColor: '#8B5CF6', backgroundColor: 'rgba(139, 92, 246, 0.1)', tension: 0.1, fill: true, pointRadius: 2, pointBackgroundColor: '#8B5CF6' }, { label: 'Zielgewicht (kg)', data: targetLine, borderColor: '#F59E0B', borderDash: [5, 5], fill: false, pointRadius: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: true, position: 'bottom', labels: { color: isDark ? '#fff' : '#000' } }, tooltip: {} }, scales: { y: { beginAtZero: false, grid: { color: isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)' }, ticks: { color: isDark ? '#fff' : '#000' } }, x: { grid: { display: false }, ticks: { color: isDark ? '#fff' : '#000', autoSkip: true, maxTicksLimit: 15 } } } } });
            return () => { if (weightChartInstance.current) { weightChartInstance.current.destroy(); weightChartInstance.current = null; } };
        }, [weights, goals.targetWeight, isDark]);
        const totalExerciseMinutes = exercise.reduce((sum, e) => sum + e.duration, 0);
        const totalWaterLiters = (water.reduce((sum, w) => sum + w.amount, 0) / 1000).toFixed(1);
        const totalDaysTracked = useMemo(() => { const days = new Set(); [...food, ...exercise, ...water, ...agingData, ...weights].forEach(item => { if (item.date) days.add(item.date); }); return days.size; }, [food, exercise, water, agingData, weights]);
        return ( // JSX for StatsView
            <div className="space-y-6">
                <h2 className="text-2xl font-bold text-center text-purple-700 dark:text-purple-400 mb-6">Statistiken & Trends</h2>
                <div className="grid md:grid-cols-2 lg:grid-cols-4 gap-5">
                    <div className={`p-5 rounded-2xl shadow-lg ${isDark ? 'bg-gray-800' : 'bg-white bg-opacity-90'} flex flex-col items-center text-center`}><i className="fas fa-fire-alt text-4xl text-orange-500 mb-3"></i><h3 className="font-semibold text-lg mb-1">Aktuelle Strähne</h3><p className="text-3xl font-bold mb-2">{currentStreak} <span className="text-lg font-normal">Tage</span></p><p className="text-sm text-gray-600 dark:text-gray-400">Längste: {longestStreak} Tage</p></div>
                    <div className={`p-5 rounded-2xl shadow-lg ${isDark ? 'bg-gray-800' : 'bg-white bg-opacity-90'} flex flex-col items-center text-center`}><i className="fas fa-calendar-check text-4xl text-blue-500 mb-3"></i><h3 className="font-semibold text-lg mb-1">Tage getrackt</h3><p className="text-3xl font-bold mb-2">{totalDaysTracked}</p><p className="text-sm text-gray-600 dark:text-gray-400">Gesamte Aktivitätstage</p></div>
                    <div className={`p-5 rounded-2xl shadow-lg ${isDark ? 'bg-gray-800' : 'bg-white bg-opacity-90'} flex flex-col items-center text-center`}><i className="fas fa-dumbbell text-4xl text-green-500 mb-3"></i><h3 className="font-semibold text-lg mb-1">Training Gesamt</h3><p className="text-3xl font-bold mb-2">{totalExerciseMinutes} <span className="text-lg font-normal">Min</span></p><p className="text-sm text-gray-600 dark:text-gray-400">Alle Trainingseinheiten</p></div>
                    <div className={`p-5 rounded-2xl shadow-lg ${isDark ? 'bg-gray-800' : 'bg-white bg-opacity-90'} flex flex-col items-center text-center`}><i className="fas fa-tint text-4xl text-cyan-500 mb-3"></i><h3 className="font-semibold text-lg mb-1">Wasser Gesamt</h3><p className="text-3xl font-bold mb-2">{totalWaterLiters} <span className="text-lg font-normal">L</span></p><p className="text-sm text-gray-600 dark:text-gray-400">Gesamte Trinkmenge</p></div>
                </div>
                <Card title="Aktivitäten & Langlebigkeit (Letzte 7 Tage)" color="#22c55e"><div className="h-72 md:h-96 w-full"><canvas ref={activityChartRef}></canvas></div><p className="text-xs text-center mt-2 text-gray-500 dark:text-gray-400">Zeigt Mahlzeiten-/Übungsanzahl, Wasser (L) und Langlebigkeitsscore (%).</p></Card>
                <Card title="Gewichtsverlauf (Gesamt)" color="#f59e0b"><div className="h-72 md:h-96 w-full">{weights.length < 1 && <p className="text-center flex items-center justify-center h-full text-gray-500 dark:text-gray-400">Keine Gewichtsdaten zum Anzeigen.</p>}<canvas ref={weightChartRef}></canvas></div><p className="text-xs text-center mt-2 text-gray-500 dark:text-gray-400">Zeigt dein Gewicht und dein Zielgewicht über die Zeit.</p></Card>
            </div>
        );
    };

    // --- Main App Component ---
    function App() {
      // State
      const [goals, setGoals] = useState(() => safeGet(LS_KEYS.GOALS, initialGoals));
      const [food, setFood] = useState(() => safeGet(LS_KEYS.FOOD, []));
      const [exercise, setExercise] = useState(() => safeGet(LS_KEYS.EX, []));
      const [water, setWater] = useState(() => safeGet(LS_KEYS.WATER, [])); // Main water state
      const [weights, setWeights] = useState(() => safeGet(LS_KEYS.WEIGHT, []));
      const [agingData, setAgingData] = useState(() => safeGet(LS_KEYS.AGING, []));
      const [active, setActive] = useState(TABS.DASH);
      const [formErrors, setFormErrors] = useState({});
      const [tempGoals, setTempGoals] = useState(goals);
      const [savedText, setSavedText] = useState('');
      const [showAlarm, setShowAlarm] = useState(false); // State for alarm visibility
      const { isDark, toggleTheme } = useContext(ThemeContext);

      // Memos for today's data
      const todayFood = useMemo(() => food.filter(f => f.date === today), [food, today]);
      const todayExercise = useMemo(() => exercise.filter(e => e.date === today), [exercise, today]);
      const todayWater = useMemo(() => water.filter(w => w.date === today), [water, today]);
      const todayAgingData = useMemo(() => agingData.filter(a => a.date === today), [agingData, today]);

      // Effects for saving to storage
      useEffect(() => { try { storage.setItem(LS_KEYS.GOALS, JSON.stringify(goals)); } catch(e){ console.warn("Failed to save goals", e)} }, [goals]);
      useEffect(() => { try { storage.setItem(LS_KEYS.FOOD, JSON.stringify(food)); } catch(e){ console.warn("Failed to save food", e)} }, [food]);
      useEffect(() => { try { storage.setItem(LS_KEYS.EX, JSON.stringify(exercise)); } catch(e){ console.warn("Failed to save exercise", e)} }, [exercise]);
      useEffect(() => { try { storage.setItem(LS_KEYS.WATER, JSON.stringify(water)); } catch(e){ console.warn("Failed to save water", e)} }, [water]);
      useEffect(() => { try { storage.setItem(LS_KEYS.WEIGHT, JSON.stringify(weights)); } catch(e){ console.warn("Failed to save weights", e)} }, [weights]);
      useEffect(() => { try { storage.setItem(LS_KEYS.AGING, JSON.stringify(agingData)); } catch(e){ console.warn("Failed to save aging data", e)} }, [agingData]);

      // Update tempGoals if global goals change
      useEffect(() => { setTempGoals(goals); }, [goals]);

      // Calculated totals for today
      const totals = useMemo(() => {
        const cal = todayFood.reduce((s, i) => s + (i.calories || 0), 0);
        const prot = todayFood.reduce((s, i) => s + (i.protein || 0), 0);
        const carbs = todayFood.reduce((s, i) => s + (i.carbs || 0), 0);
        const fat = todayFood.reduce((s, i) => s + (i.fat || 0), 0);
        const burned = todayExercise.reduce((s, i) => s + (i.caloriesBurned || 0), 0);
        const waterAmount = todayWater.reduce((s, i) => s + (i.amount || 0), 0);
        return { cal, prot, carbs, fat, burned, net: cal - burned, water: waterAmount };
      }, [todayFood, todayExercise, todayWater]);

      // Action Handlers
      const saveGoals = () => {
        if (Object.values(tempGoals).some(val => typeof val !== 'number' || val < 0)) { alert("Bitte geben Sie gültige, positive Zahlen für alle Ziele ein."); return; }
        setGoals(tempGoals); setSavedText("✅ Ziele gespeichert!"); setTimeout(() => setSavedText(''), 2000);
      };
      const addFood = () => {
        const name = document.getElementById('foodName').value.trim();
        const calories = parseFloat(document.getElementById('foodCalories').value) || 0;
        const protein = parseFloat(document.getElementById('foodProtein').value) || 0;
        const carbs = parseFloat(document.getElementById('foodCarbs').value) || 0;
        const fat = parseFloat(document.getElementById('foodFat').value) || 0;
        const errors = {}; if (!name) errors.name = "Name ist erforderlich."; if (calories <= 0) errors.calories = "Kalorien müssen positiv sein."; if (protein < 0) errors.protein = "Protein kann nicht negativ sein."; if (carbs < 0) errors.carbs = "Kohlenhydrate können nicht negativ sein."; if (fat < 0) errors.fat = "Fett kann nicht negativ sein.";
        setFormErrors(errors);
        if (Object.keys(errors).length === 0) {
          setFood(prev => [...prev, { id: crypto.randomUUID(), name, calories, protein, carbs, fat, date: today }]);
          document.getElementById('foodName').value = ''; document.getElementById('foodCalories').value = ''; document.getElementById('foodProtein').value = ''; document.getElementById('foodCarbs').value = ''; document.getElementById('foodFat').value = ''; setFormErrors({});
        }
      };
      const addExercise = () => {
        const name = document.getElementById('exName').value.trim();
        const duration = parseInt(document.getElementById('exDuration').value, 10) || 0;
        const caloriesBurned = parseFloat(document.getElementById('exCalories').value) || 0;
        const errors = {}; if (!name) errors.name = "Name ist erforderlich."; if (duration <= 0) errors.duration = "Dauer muss positiv sein."; if (caloriesBurned < 0) errors.caloriesBurned = "Verbrannte Kalorien können nicht negativ sein.";
        setFormErrors(errors);
        if (Object.keys(errors).length === 0) {
          setExercise(prev => [...prev, { id: crypto.randomUUID(), name, duration, caloriesBurned, date: today }]);
          document.getElementById('exName').value = ''; document.getElementById('exDuration').value = ''; document.getElementById('exCalories').value = ''; setFormErrors({});
        }
      };
      const deleteFood = id => setFood(prev => prev.filter(i => i.id !== id));
      const deleteExercise = id => setExercise(prev => prev.filter(i => i.id !== id));

      // --- Reset Function ---
      const resetAllData = () => {
        if (window.confirm("Bist du sicher, dass du ALLE deine Daten löschen möchtest? Diese Aktion kann nicht rückgängig gemacht werden!")) {
            console.log("Resetting all data...");
            // Reset state variables
            setGoals(initialGoals);
            setFood([]);
            setExercise([]);
            setWater([]);
            setWeights([]);
            setAgingData([]);
            setTempGoals(initialGoals); // Reset temp goals as well
            setActive(TABS.DASH); // Go back to dashboard

            // Clear storage
            Object.values(LS_KEYS).forEach(key => {
                try {
                    storage.removeItem(key);
                    console.log(`Removed ${key} from storage.`);
                } catch (e) {
                    console.warn(`Could not remove ${key} from storage.`, e);
                }
            });

             // Optional: Clear theme preference as well
             try {
                 storage.removeItem('themePref');
             } catch (e) {
                 console.warn("Could not remove theme preference from storage.", e);
             }

            console.log("Data reset complete.");
            alert("Alle Daten wurden zurückgesetzt."); // Inform user
        }
      };
      // --- End Reset Function ---


      // Today's Longevity Score for Header
      const todayLongevityScore = useMemo(() => {
          const totalTargets = longevityItems.reduce((sum, item) => sum + item.target, 0);
          if (totalTargets === 0) return 0;
          const achieved = todayAgingData.reduce((sum, item) => { const definition = longevityItems.find(i => i.id === item.id); return sum + (definition ? Math.min(item.count, definition.target) : 0); }, 0);
          return Math.round((achieved / totalTargets) * 100);
      }, [todayAgingData]);

      // --- Render App ---
      return (
        <div className="max-w-5xl mx-auto px-4 py-8">
          {/* Header */}
          <div className="flex justify-between items-center mb-6 flex-wrap gap-2">
            <h1 className="font-extrabold text-2xl sm:text-3xl text-purple-700 dark:text-purple-400 flex items-center"><i className="fas fa-heartbeat mr-2 text-pink-500"/>Fitness & Langlebigkeit</h1>
            <button onClick={toggleTheme} className="p-2 rounded-full bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors" aria-label={isDark ? "Light Mode aktivieren" : "Dark Mode aktivieren"}>{isDark ? <i className="fas fa-sun text-yellow-300"/> : <i className="fas fa-moon text-gray-700"/>}</button>
          </div>
          {/* Date & Score Header */}
          <div className="mb-6 p-3 rounded-xl bg-gradient-to-r from-blue-50 to-purple-50 dark:from-blue-900/20 dark:to-purple-900/20 text-sm text-center shadow-sm"><p className="text-gray-700 dark:text-gray-300"><span className="font-medium">{getDateForDisplay()}</span><span className="mx-2 text-gray-400 dark:text-gray-600">•</span><span>Langlebigkeits-Score heute: <span className="font-semibold text-purple-600 dark:text-purple-400">{todayLongevityScore}%</span></span></p></div>
          {/* Tabs */}
          <Tabs active={active} setActive={setActive} />

          {/* --- Tab Content --- */}
          {/* DASHBOARD */}
          {active === TABS.DASH && (
            <div className="space-y-6 animate-fade-in">
              {/* --- Alarm Clock Section --- */}
              <div className={`p-4 rounded-lg shadow ${isDark ? 'bg-gray-800/50' : 'bg-white/50'} backdrop-blur-sm border ${isDark ? 'border-gray-700' : 'border-gray-200'}`}>
                <button
                  onClick={() => setShowAlarm(!showAlarm)}
                  className={`mb-3 px-4 py-2 rounded-lg font-semibold transition flex items-center gap-2 shadow-sm ${
                    showAlarm
                      ? 'bg-amber-500 hover:bg-amber-600 text-white'
                      : 'bg-blue-500 hover:bg-blue-600 text-white'
                  }`}
                >
                  <i className={`fas ${showAlarm ? 'fa-clock-rotate-left' : 'fa-stopwatch-20'}`}></i>
                  {showAlarm ? 'Wecker ausblenden' : 'Wecker anzeigen'}
                </button>
                <div className={`iframe-container ${showAlarm ? 'h-[650px] opacity-100' : 'h-0 opacity-0'}`}>
                  {showAlarm && (
                    <iframe
                      srcDoc={alarmClockHtml}
                      title="Digitaler Wecker"
                      className="w-full h-full border-0 rounded-md"
                      sandbox="allow-scripts allow-same-origin" // allow-same-origin is needed for localStorage within the iframe
                    ></iframe>
                  )}
                </div>
              </div>
              {/* --- End Alarm Clock Section --- */}

              <div className="grid md:grid-cols-3 gap-5">
                <Card title="Kalorienbilanz" color="#3b82f6"><div className="flex items-center justify-between mb-2 text-sm"><div><p>Aufgenommen: {totals.cal} kcal</p><p>Verbrannt: {totals.burned} kcal</p><p className="font-semibold">Netto: {totals.net} kcal</p></div><div className="text-4xl text-blue-500 dark:text-blue-400"><i className="fas fa-fire-alt"></i></div></div><p className="text-xs text-gray-500 dark:text-gray-400 mb-1">Ziel: {goals.dailyCalories} kcal</p><ProgressBar value={totals.net} max={goals.dailyCalories} showPercentage={true}/></Card>
                <Card title="Makronährstoffe" color="#8b5cf6"><div className="space-y-3 text-sm"><div><div className="flex justify-between"><span>Protein: {totals.prot}g</span><span>Ziel: {goals.dailyProtein}g</span></div><ProgressBar value={totals.prot} max={goals.dailyProtein} color="bg-red-400"/></div><div><div className="flex justify-between"><span>Kohlenhydrate: {totals.carbs}g</span><span>Ziel: {goals.dailyCarbs}g</span></div><ProgressBar value={totals.carbs} max={goals.dailyCarbs} color="bg-yellow-400"/></div><div><div className="flex justify-between"><span>Fett: {totals.fat}g</span><span>Ziel: {goals.dailyFat}g</span></div><ProgressBar value={totals.fat} max={goals.dailyFat} color="bg-green-400"/></div></div></Card>
                <Card title="Training & Hydration" color="#22c55e"><div className="space-y-4 text-sm"><div><p>Verbrannte Kalorien: {totals.burned} kcal</p><p>Trainingsdauer: {todayExercise.reduce((s, i) => s + (i.duration || 0), 0)} Min</p><p className="text-xs text-gray-500 dark:text-gray-400 mt-1">Ziel: {goals.exerciseMinutes} Min/Tag</p></div><div className="pt-3 border-t border-gray-200 dark:border-gray-700"><div className="flex justify-between items-center mb-1"><span>Wasser: {(totals.water / 1000).toFixed(1)} L</span><span>Ziel: {goals.dailyWater / 1000} L</span><i className="fas fa-tint text-blue-500 ml-1"></i></div><ProgressBar value={totals.water} max={goals.dailyWater} color="bg-blue-400" showPercentage={true} /></div></div></Card>
              </div>
              <div className="grid md:grid-cols-2 gap-5">
                <Card title="Körpergewicht Tracker" color="#f59e0b"><WeightTracker weights={weights} setWeights={setWeights} targetWeight={goals.targetWeight} /></Card>
                <Card title="Hydration Tracker (Heute)" color="#3b82f6">
                  <WaterTracker waterData={water} setWaterState={setWater} goal={goals.dailyWater} />
                </Card>
              </div>
              <Card title="Langlebigkeits-Aktivitäten (Heute)" color="#a855f7"><div className="flex flex-wrap gap-2">{longevityItems.map(item => { const userItem = todayAgingData.find(i => i.id === item.id); const isComplete = userItem && userItem.count >= item.target; const currentCount = userItem ? userItem.count : 0; return (<button key={item.id} onClick={() => { const index = agingData.findIndex(i => i.id === item.id && i.date === today); const itemDefinition = longevityItems.find(i => i.id === item.id); if (index >= 0) { const updatedItem = { ...agingData[index] }; updatedItem.count = (updatedItem.count >= itemDefinition.target) ? 0 : updatedItem.count + 1; const newData = [...agingData]; newData[index] = updatedItem; setAgingData(newData); } else { setAgingData(prev => [...prev, { id: item.id, count: 1, target: itemDefinition.target, date: today }]); } }} className={`px-3 py-1.5 rounded-full flex items-center gap-1.5 transition-all duration-200 text-xs shadow-sm ${isComplete ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200 ring-1 ring-green-300 dark:ring-green-700' : currentCount > 0 ? 'bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200 ring-1 ring-purple-300 dark:ring-purple-700' : isDark ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-gray-100 text-gray-800 hover:bg-gray-200'}`} title={`${item.title} (${currentCount}/${item.target})`}>{isComplete ? <i className="fas fa-check-circle text-green-500"></i> : currentCount > 0 ? <i className="fas fa-spinner fa-spin text-purple-500"></i> : <i className="far fa-circle text-gray-400"></i>}<span>{item.title.split(' ')[0]}</span>{item.target > 1 && <span className="text-xs px-1.5 py-0.5 rounded-full bg-opacity-70 bg-white dark:bg-gray-800">{currentCount}/{item.target}</span>}</button>); })}</div><button onClick={() => setActive(TABS.AGING)} className="mt-4 text-sm text-purple-600 dark:text-purple-400 hover:underline">Alle Langlebigkeits-Details anzeigen <i className="fas fa-arrow-right ml-1"></i></button></Card>
            </div>
          )}
          {/* FOOD TAB */}
          {active === TABS.FOOD && (
            <div className="space-y-6 animate-fade-in">
              <Card title="Neues Lebensmittel hinzufügen" color="#3b82f6"><div className="grid md:grid-cols-3 gap-4 items-start"><div className="space-y-3"><div><label htmlFor="foodName" className="block text-sm font-medium mb-1">Name*</label><input type="text" id="foodName" placeholder="z.B. Hähnchenbrust" className={`w-full p-2 rounded border text-base ${formErrors.name ? 'border-red-500 bg-red-50 dark:bg-red-900/20' : 'border-gray-300 dark:border-gray-600 dark:bg-gray-700'}`} />{formErrors.name && <p className="text-red-500 text-xs mt-1">{formErrors.name}</p>}</div><div><label htmlFor="foodCalories" className="block text-sm font-medium mb-1">Kalorien (kcal)*</label><input type="number" id="foodCalories" placeholder="z.B. 165" min="0" className={`w-full p-2 rounded border text-base ${formErrors.calories ? 'border-red-500 bg-red-50 dark:bg-red-900/20' : 'border-gray-300 dark:border-gray-600 dark:bg-gray-700'}`} />{formErrors.calories && <p className="text-red-500 text-xs mt-1">{formErrors.calories}</p>}</div></div><div className="space-y-3"><div><label htmlFor="foodProtein" className="block text-sm font-medium mb-1">Protein (g)</label><input type="number" id="foodProtein" placeholder="z.B. 31" min="0" step="0.1" className={`w-full p-2 rounded border text-base ${formErrors.protein ? 'border-red-500 bg-red-50 dark:bg-red-900/20' : 'border-gray-300 dark:border-gray-600 dark:bg-gray-700'}`} />{formErrors.protein && <p className="text-red-500 text-xs mt-1">{formErrors.protein}</p>}</div><div><label htmlFor="foodCarbs" className="block text-sm font-medium mb-1">Kohlenhydrate (g)</label><input type="number" id="foodCarbs" placeholder="z.B. 0" min="0" step="0.1" className={`w-full p-2 rounded border text-base ${formErrors.carbs ? 'border-red-500 bg-red-50 dark:bg-red-900/20' : 'border-gray-300 dark:border-gray-600 dark:bg-gray-700'}`} />{formErrors.carbs && <p className="text-red-500 text-xs mt-1">{formErrors.carbs}</p>}</div></div><div className="space-y-3"><div><label htmlFor="foodFat" className="block text-sm font-medium mb-1">Fett (g)</label><input type="number" id="foodFat" placeholder="z.B. 3.6" min="0" step="0.1" className={`w-full p-2 rounded border text-base ${formErrors.fat ? 'border-red-500 bg-red-50 dark:bg-red-900/20' : 'border-gray-300 dark:border-gray-600 dark:bg-gray-700'}`} />{formErrors.fat && <p className="text-red-500 text-xs mt-1">{formErrors.fat}</p>}</div><div className="pt-5"><button onClick={addFood} className="w-full px-4 py-2 rounded-lg bg-blue-500 hover:bg-blue-600 text-white font-semibold transition shadow-sm"><i className="fas fa-plus mr-2"/>Hinzufügen</button></div></div></div></Card>
              <Card title="Essensprotokoll (Heute)" color="#3b82f6">{todayFood.length > 0 && <div className="mb-4 p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg"><p className="font-medium mb-2">Heutige Zusammenfassung:</p><div className="grid grid-cols-2 sm:grid-cols-4 gap-2 text-sm text-center"><div className="p-2 bg-blue-100 dark:bg-blue-900/30 rounded"><p className="text-blue-700 dark:text-blue-400 text-xs">Kalorien</p><p className="font-bold">{totals.cal} kcal</p></div><div className="p-2 bg-red-100 dark:bg-red-900/30 rounded"><p className="text-red-700 dark:text-red-400 text-xs">Protein</p><p className="font-bold">{totals.prot} g</p></div><div className="p-2 bg-yellow-100 dark:bg-yellow-900/30 rounded"><p className="text-yellow-700 dark:text-yellow-400 text-xs">Kohlenhydrate</p><p className="font-bold">{totals.carbs} g</p></div><div className="p-2 bg-green-100 dark:bg-green-900/30 rounded"><p className="text-green-700 dark:text-green-400 text-xs">Fett</p><p className="font-bold">{totals.fat} g</p></div></div>{totals.cal > 0 && <p className="text-xs text-center mt-2 text-gray-600 dark:text-gray-400">Verteilung: P: {Math.round(totals.prot * 4 / totals.cal * 100)}% | KH: {Math.round(totals.carbs * 4 / totals.cal * 100)}% | F: {Math.round(totals.fat * 9 / totals.cal * 100)}%</p>}</div>}<LogList items={todayFood} onDelete={deleteFood} renderItem={i => <><p className="font-medium">{i.name}</p><p className="text-sm text-gray-600 dark:text-gray-400 break-words">{i.calories} kcal | <span className="text-red-500 dark:text-red-400">P:{i.protein}g</span> | <span className="text-yellow-500 dark:text-yellow-400">KH:{i.carbs}g</span> | <span className="text-green-500 dark:text-green-400">F:{i.fat}g</span></p></>}/></Card>
            </div>
          )}
          {/* EXERCISE TAB */}
          {active === TABS.EX && (
            <div className="space-y-6 animate-fade-in">
              <Card title="Neues Training hinzufügen" color="#22c55e"><div className="grid md:grid-cols-3 gap-4 items-start"><div><label htmlFor="exName" className="block text-sm font-medium mb-1">Übung/Aktivität*</label><input type="text" id="exName" placeholder="z.B. Laufen, Krafttraining" className={`w-full p-2 rounded border text-base ${formErrors.name ? 'border-red-500 bg-red-50 dark:bg-red-900/20' : 'border-gray-300 dark:border-gray-600 dark:bg-gray-700'}`} />{formErrors.name && <p className="text-red-500 text-xs mt-1">{formErrors.name}</p>}</div><div><label htmlFor="exDuration" className="block text-sm font-medium mb-1">Dauer (Minuten)*</label><input type="number" id="exDuration" placeholder="z.B. 30" min="1" className={`w-full p-2 rounded border text-base ${formErrors.duration ? 'border-red-500 bg-red-50 dark:bg-red-900/20' : 'border-gray-300 dark:border-gray-600 dark:bg-gray-700'}`} />{formErrors.duration && <p className="text-red-500 text-xs mt-1">{formErrors.duration}</p>}</div><div><label htmlFor="exCalories" className="block text-sm font-medium mb-1">Kalorien verbrannt (kcal)</label><input type="number" id="exCalories" placeholder="Optional, z.B. 250" min="0" className={`w-full p-2 rounded border text-base ${formErrors.caloriesBurned ? 'border-red-500 bg-red-50 dark:bg-red-900/20' : 'border-gray-300 dark:border-gray-600 dark:bg-gray-700'}`} />{formErrors.caloriesBurned && <p className="text-red-500 text-xs mt-1">{formErrors.caloriesBurned}</p>}</div></div><button onClick={addExercise} className="mt-4 px-4 py-2 rounded-lg bg-green-500 hover:bg-green-600 text-white font-semibold transition shadow-sm"><i className="fas fa-plus mr-2"/>Hinzufügen</button></Card>
              <div className="grid md:grid-cols-1 gap-5"><Card title="Trainingsprotokoll (Heute)" color="#22c55e"><LogList items={todayExercise} onDelete={deleteExercise} renderItem={i => <><p className="font-medium">{i.name}</p><p className="text-sm text-gray-600 dark:text-gray-400">{i.duration} Min {i.caloriesBurned > 0 ? `| ${i.caloriesBurned} kcal verbrannt` : ''}</p></>}/>{todayExercise.length > 0 && <div className="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700"><div className="flex flex-wrap justify-between text-sm gap-2"><span>Gesamtzeit heute: <span className="font-semibold">{todayExercise.reduce((s, i) => s + i.duration, 0)} Min</span></span>{totals.burned > 0 && <span>Gesamt verbrannt: <span className="font-semibold">{totals.burned} kcal</span></span>}</div><p className="text-xs text-gray-500 dark:text-gray-400 mt-1">Tagesziel: {goals.exerciseMinutes} Min</p></div>}</Card></div>
            </div>
          )}
          {/* GOALS TAB */}
          {active === TABS.GOALS && (
            <div className="space-y-6 animate-fade-in">
              <Card title="Deine Ziele festlegen" color="#f59e0b">
                {/* Goal Inputs */}
                <div className="grid md:grid-cols-2 gap-x-6 gap-y-4 mb-6">{Object.keys(initialGoals).map(key => { const labelsMap = { targetWeight: "Zielgewicht (kg)", dailyCalories: "Tägliche Kalorien (kcal)", dailyProtein: "Tägliches Protein (g)", dailyCarbs: "Tägliche Kohlenhydrate (g)", dailyFat: "Tägliches Fett (g)", dailyWater: "Tägliches Wasser (ml)", exerciseMinutes: "Tägliches Training (Min)" }; const stepMap = { dailyWater: 100, targetWeight: 0.1 }; return (<div className="flex flex-col" key={key}><label htmlFor={`goal-${key}`} className="mb-1 font-medium text-sm">{labelsMap[key]}</label><input type="number" id={`goal-${key}`} value={tempGoals[key] ?? 0} onChange={e => { const value = e.target.value; setTempGoals({...tempGoals, [key]: value === '' ? '' : parseFloat(value) }); }} onBlur={e => { if (e.target.value === '') setTempGoals({...tempGoals, [key]: 0 }); }} className="p-2 rounded border text-base dark:bg-gray-700 dark:border-gray-600 focus:ring-2 focus:ring-purple-500 focus:border-transparent" min="0" step={stepMap[key] || 1}/></div>); })}</div>
                {/* Save Button */}
                <div className="flex items-center gap-4">
                    <button onClick={saveGoals} className="px-5 py-2 rounded-lg bg-purple-500 hover:bg-purple-600 text-white font-semibold transition shadow-sm"><i className="fas fa-save mr-2"/>Ziele speichern</button>
                    <div className="text-green-600 font-semibold h-6 transition-opacity duration-300" style={{ opacity: savedText ? 1 : 0 }}>{savedText}</div>
                </div>
                 {/* Reset Button Area */}
                 <div className="mt-8 pt-6 border-t border-gray-200 dark:border-gray-700">
                     <h4 className="font-semibold text-lg mb-3 text-danger">Daten zurücksetzen</h4>
                     <p className="text-sm text-gray-600 dark:text-gray-400 mb-4">
                         Achtung: Hiermit werden alle deine gespeicherten Daten (Ziele, Mahlzeiten, Training, Wasser, Gewicht, Langlebigkeit) unwiderruflich gelöscht.
                     </p>
                     <button
                         onClick={resetAllData}
                         className="px-5 py-2 rounded-lg bg-danger hover:bg-red-700 text-white font-semibold transition shadow-sm flex items-center gap-2"
                     >
                         <i className="fas fa-exclamation-triangle mr-1"></i>
                         Alle Daten löschen & Zurücksetzen
                     </button>
                 </div>
              </Card>
              <Card title="Tipps für realistische Ziele" color="#3b82f6"><div className="space-y-3 text-sm"><div className="p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg border-l-4 border-blue-400"><p className="font-medium text-blue-700 dark:text-blue-400">SMART Ziele</p><p className="text-gray-700 dark:text-gray-300">Setze <span className="font-semibold">S</span>pezifische, <span className="font-semibold">M</span>essbare, <span className="font-semibold">A</span>ttraktive, <span className="font-semibold">R</span>ealistische, <span className="font-semibold">T</span>erminierte Ziele.</p></div><div className="p-3 bg-purple-50 dark:bg-purple-900/20 rounded-lg border-l-4 border-purple-400"><p className="font-medium text-purple-700 dark:text-purple-400">Proteinbedarf</p><p className="text-gray-700 dark:text-gray-300">1,6-2,2g Protein pro kg Körpergewicht sind oft empfohlen für Muskelaufbau/-erhalt bei Training.</p></div><div className="p-3 bg-green-50 dark:bg-green-900/20 rounded-lg border-l-4 border-green-400"><p className="font-medium text-green-700 dark:text-green-400">Hydration</p><p className="text-gray-700 dark:text-gray-300">~30-40ml Wasser pro kg Körpergewicht ist ein guter Startpunkt. Mehr bei Hitze/Sport.</p></div><div className="p-3 bg-yellow-50 dark:bg-yellow-900/20 rounded-lg border-l-4 border-yellow-400"><p className="font-medium text-yellow-700 dark:text-yellow-400">Kaloriendefizit/-überschuss</p><p className="text-gray-700 dark:text-gray-300">Ein moderates Defizit (300-500 kcal) fördert nachhaltigen Fettverlust. Ein kleiner Überschuss (200-400 kcal) unterstützt Muskelaufbau.</p></div></div></Card>
            </div>
          )}
          {/* AGING TAB */}
          {active === TABS.AGING && (
            <div className="animate-fade-in"><LongevityTracker agingData={agingData} setAgingData={setAgingData} /></div>
          )}
          {/* STATS TAB */}
          {active === TABS.STATS && (
            <div className="animate-fade-in"><StatsView food={food} exercise={exercise} water={water} weights={weights} agingData={agingData} goals={goals} /></div>
          )}

          {/* Footer */}
          <footer className="mt-12 text-center text-xs text-gray-500 dark:text-gray-400"><p>Deine Daten werden {storage === localStorage ? 'lokal im Browser gespeichert.' : 'nur temporär für diese Sitzung gespeichert (localStorage nicht verfügbar).'}</p><p className="mt-1">Version 3.4 © {new Date().getFullYear()}</p></footer>
        </div>
      );
    }

    // --- Error Boundary ---
    class ErrorBoundary extends Component {
      constructor(props) { super(props); this.state = { hasError: false, error: null, errorInfo: null }; }
      static getDerivedStateFromError(error) { return { hasError: true }; }
      componentDidCatch(error, errorInfo) { console.error("Error caught by boundary:", error, errorInfo); this.setState({ error: error, errorInfo: errorInfo }); }
      render() {
        if (this.state.hasError) {
          const isDark = document.documentElement.classList.contains('dark');
          return (
            <div className="max-w-2xl mx-auto my-10"><div className={`p-6 rounded-xl shadow-lg text-center ${isDark ? 'bg-gray-800 text-white' : 'bg-white'}`}><div className="mb-4 text-red-500"><i className="fas fa-exclamation-triangle text-4xl"></i></div><h2 className="text-2xl font-bold mb-4">Ein Fehler ist aufgetreten</h2><p className="mb-4">Entschuldigung, die Anwendung konnte nicht korrekt geladen werden. Bitte versuche, die Seite neu zu laden.</p><div className="mb-4"><button onClick={() => window.location.reload()} className="px-4 py-2 bg-purple-500 hover:bg-purple-600 text-white rounded-lg transition"><i className="fas fa-sync-alt mr-2"></i>Seite neu laden</button></div>{this.state.error && <details className="text-left mt-4 p-4 bg-gray-100 dark:bg-gray-700 rounded-lg text-xs"><summary className="cursor-pointer font-medium mb-2">Technische Details</summary><p className="text-red-600 dark:text-red-400 mb-2">{this.state.error.toString()}</p>{this.state.errorInfo?.componentStack && <pre className="overflow-auto p-2 bg-gray-200 dark:bg-gray-800 rounded max-h-40">{this.state.errorInfo.componentStack}</pre>}</details>}</div></div>
          );
        }
        return this.props.children;
      }
    }

    // --- Render App ---
    const AppWithErrorHandling = () => (<ThemeProvider><ErrorBoundary><App /></ErrorBoundary></ThemeProvider>);
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<AppWithErrorHandling />);

  </script>
</body>
</html>
