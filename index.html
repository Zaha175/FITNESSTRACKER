<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Fitness & Langlebigkeits Tracker</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: '#5D5CDE',
            secondary: '#8B5CF6',
            success: '#22C55E',
            warning: '#F59E0B',
            danger: '#EF4444', // Rot für Gefahr/Reset
            info: '#3B82F6'
          },
          animation: {
            'pulse-fast': 'pulse 1s cubic-bezier(0.4, 0, 0.6, 1) infinite',
            'spin-slow': 'spin 3s linear infinite',
            'bounce-slow': 'bounce 2s infinite',
          }
        }
      }
    }
  </script>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"/>

  <style>
    body {
      font-family: 'Inter', sans-serif;
      transition: background-color 0.3s ease;
    }

    .dark body {
      background-image: linear-gradient(to top right, rgba(76, 29, 149, 0.15), rgba(30, 58, 138, 0.15), rgba(124, 58, 237, 0.15));
    }

    .card-transition {
      transition: all 0.3s ease;
    }

    .card-transition:hover {
      transform: translateY(-5px);
    }

    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button {
      opacity: 1;
    }

    /* Fade-in animation */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate-fade-in {
      animation: fadeIn 0.5s ease-in-out;
    }

    /* Styling for the iframe container */
    .iframe-container {
        transition: all 0.3s ease-out;
        overflow: hidden; /* Ensures content doesn't spill during transition */
    }

  </style>
</head>
<body class="min-h-screen bg-gradient-to-tr from-pink-100 via-blue-100 to-violet-100 bg-fixed dark:from-slate-900 dark:via-purple-900 dark:to-slate-900">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo, useRef, createContext, useContext, Component } = React;

    // --- Storage Fallback Implementation ---
    const memoryStorage = {
      _data: {},
      getItem(key) { return this._data.hasOwnProperty(key) ? this._data[key] : null; },
      setItem(key, value) { this._data[key] = String(value); },
      removeItem(key) { delete this._data[key]; },
      clear() { this._data = {}; }
    };
    const storage = (function() {
      try {
        localStorage.setItem('__storage_test__', 'test');
        localStorage.removeItem('__storage_test__');
        console.log("Using localStorage for persistence.");
        return localStorage;
      } catch (e) {
        console.warn('localStorage is not available. Using temporary in-memory storage.', e);
        return memoryStorage;
      }
    })();
    // --- End Storage Fallback ---

    // Theme context
    const ThemeContext = createContext();
    const ThemeProvider = ({ children }) => {
      const [isDark, setIsDark] = useState(() => {
        let darkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        try {
            const storedPref = storage.getItem('themePref');
            if (storedPref) darkMode = storedPref === 'dark';
        } catch (e) { console.warn("Could not read theme preference from storage.", e); }
        if (darkMode) document.documentElement.classList.add('dark');
        else document.documentElement.classList.remove('dark');
        return darkMode;
      });
      useEffect(() => {
        const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
        const handleChange = (e) => {
          try {
              if (!storage.getItem('themePref')) {
                  setIsDark(e.matches);
                  if (e.matches) document.documentElement.classList.add('dark');
                  else document.documentElement.classList.remove('dark');
              }
          } catch (e) {
              console.warn("Could not access storage in theme media query handler.", e);
              setIsDark(e.matches);
              if (e.matches) document.documentElement.classList.add('dark');
              else document.documentElement.classList.remove('dark');
          }
        };
        mediaQuery.addEventListener('change', handleChange);
        return () => mediaQuery.removeEventListener('change', handleChange);
      }, []);
      const toggleTheme = () => {
        setIsDark(prev => {
          const newValue = !prev;
          const themeValue = newValue ? 'dark' : 'light';
          try { storage.setItem('themePref', themeValue); } catch (e) { console.warn("Could not save theme preference to storage.", e); }
          if (newValue) document.documentElement.classList.add('dark');
          else document.documentElement.classList.remove('dark');
          return newValue;
        });
      };
      return <ThemeContext.Provider value={{ isDark, toggleTheme }}>{children}</ThemeContext.Provider>;
    };

    // Constants and Helpers
    const LS_KEYS = { GOALS: 'fitGoals', FOOD: 'fitFood', EX: 'fitEx', WATER: 'fitWater', WEIGHT: 'fitWeight', AGING: 'fitAging' };
    const TABS = { DASH: 'dashboard', FOOD: 'food', EX: 'exercise', GOALS: 'goals', AGING: 'aging', STATS: 'stats' };
    const TAB_LABELS = { dashboard: 'Übersicht', food: 'Essen', exercise: 'Training', goals: 'Ziele', aging: 'Langlebigkeit', stats: 'Statistik' };
    const initialGoals = { targetWeight: 70, dailyCalories: 2000, dailyProtein: 150, dailyCarbs: 250, dailyFat: 60, dailyWater: 2500, exerciseMinutes: 30 };
    const longevityItems = [
      { id: 'hiit', title: "HIIT-Einheiten pro Woche", info: "Steigert Mitochondrien, aktiviert Autophagie", target: 3 },
      { id: 'steps', title: "10.000 Schritte täglich", info: "Fördert kardiovaskuläre Gesundheit", target: 1 },
      { id: 'fasting', title: "Intermittierendes Fasten (16:8)", info: "Aktiviert Autophagie, reduziert Zellalterung", target: 1 },
      { id: 'omega3', title: "Omega-3 reiche Ernährung", info: "Senkt Entzündung, schützt Zellmembranen", target: 1 },
      { id: 'meditation', title: "Meditation/Atemübungen", info: "Reduziert Cortisol, schützt Telomere", target: 1 },
      { id: 'sleep', title: "7-8 Stunden Schlaf", info: "Fördert DNA-Reparatur, hormonelle Balance", target: 1 },
      { id: 'plants', title: "5+ verschiedene Pflanzen/Tag", info: "Fördert Mikrobiom-Diversität", target: 1 },
      { id: 'strength', title: "Krafttraining 2-3x/Woche", info: "Hält Muskelmasse, Insulinsensitivität", target: 2 }
    ];
    const safeGet = (key, defaultValue) => {
      try {
        const item = storage.getItem(key);
        return (item !== null && item !== undefined) ? JSON.parse(item) : defaultValue;
      } catch (error) {
        console.error(`Error reading/parsing item "${key}":`, error);
        try { storage.removeItem(key); } catch (removeError) { console.error(`Failed to remove corrupted item "${key}":`, removeError); }
        return defaultValue;
      }
    };
    const formatDate = (date = new Date()) => date.toISOString().split('T')[0];
    const today = formatDate();
    const getDateForDisplay = (date = today) => {
      try {
          const d = new Date(date);
          if (isNaN(d.getTime())) return "Ungültiges Datum";
          return d.toLocaleDateString('de-DE', { weekday: 'short', day: '2-digit', month: '2-digit', year: 'numeric' });
      } catch (e) { console.error(`Error formatting date: ${date}`, e); return "Datumsfehler"; }
    };

    // --- ULTIMATE TIMER HUB HTML ---
    // Store the HTML content for the timer hub in a variable
    const ultimateTimerHubHtml = `
<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate Timer Hub</title>
    <script src="https://cdn.tailwindcss.com"><\/script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            200: '#bae6fd',
                            300: '#7dd3fc',
                            400: '#38bdf8',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                            800: '#075985',
                            900: '#0c4a6e',
                        }
                    },
                    animation: {
                        'pulse-fast': 'pulse 1s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'spin-slow': 'spin 3s linear infinite',
                        'bounce-slow': 'bounce 2s infinite',
                    }
                }
            }
        }
    <\/script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"><\/script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"><\/script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"><\/script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto+Mono:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        /* Base styles */
        html, body, #root {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; /* Prevent scrolling */
        }
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #1e293b, #0f172a);
        }
        .monospace {
            font-family: 'Roboto Mono', monospace;
        }
        
        /* Button and input styles */
        .btn-3d {
            transition: all 0.15s ease-in-out;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3), inset 0 -2px 3px rgba(0, 0, 0, 0.25);
            border-radius: 0.5rem;
            font-weight: 600;
            padding: 0.75rem 1rem;
            position: relative;
            overflow: hidden;
        }
        .btn-3d:hover:not(:disabled) {
            transform: translateY(-1px);
        }
        .btn-3d:active:not(:disabled) {
            transform: translateY(2px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3), inset 0 -1px 2px rgba(0, 0, 0, 0.25);
        }
        .btn-3d:disabled {
            cursor: not-allowed;
            opacity: 0.7;
        }
        
        /* Timer display styles */
        .timer-display {
            text-shadow: 0 0 10px rgba(56, 189, 248, 0.6), 0 0 15px rgba(56, 189, 248, 0.4);
            font-variant-numeric: tabular-nums;
        }
        
        /* Clock face */
        .clock-face {
            position: relative;
            width: 200px;
            height: 200px;
            margin: 0 auto;
            border-radius: 50%;
            background: linear-gradient(145deg, #111827, #1e293b);
            box-shadow: 
                inset 0 0 30px rgba(0, 0, 0, 0.5),
                0 0 15px rgba(56, 189, 248, 0.5);
            border: 4px solid rgba(56, 189, 248, 0.3);
        }
        
        .clock-hand {
            position: absolute;
            top: 50%;
            left: 50%;
            transform-origin: 50% 0;
            border-radius: 4px;
        }
        
        .second-hand {
            height: 85px;
            width: 2px;
            background-color: #ef4444;
            transform: translate(-50%, 0) rotate(0deg);
        }
        
        .minute-hand {
            height: 70px;
            width: 4px;
            background-color: #38bdf8;
            transform: translate(-50%, 0) rotate(0deg);
        }
        
        .hour-hand {
            height: 50px;
            width: 6px;
            background-color: #22d3ee;
            transform: translate(-50%, 0) rotate(0deg);
        }
        
        .clock-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 12px;
            height: 12px;
            background-color: #f8fafc;
            border-radius: 50%;
            box-shadow: 0 0 8px rgba(255, 255, 255, 0.5);
            z-index: 10;
        }
        
        .timer-marker {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 100%;
            height: 100%;
            transform-origin: 50% 50%;
        }
        
        .timer-marker::before {
            content: '';
            position: absolute;
            top: 2px;
            left: 50%;
            transform: translateX(-50%);
            width: 4px;
            height: 10px;
            background-color: rgba(56, 189, 248, 0.8);
            border-radius: 2px;
        }
        
        /* Progress ring */
        .progress-ring {
            transform: rotate(-90deg);
        }
        
        /* Custom slider */
        .custom-slider {
            -webkit-appearance: none;
            appearance: none;
            background: transparent;
            cursor: pointer;
        }
        
        .custom-slider::-webkit-slider-runnable-track {
            background: linear-gradient(90deg, #0284c7, #38bdf8);
            border-radius: 4px;
            height: 6px;
        }
        
        .custom-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            margin-top: -6px;
            background-color: #f8fafc;
            border-radius: 50%;
            height: 18px;
            width: 18px;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
        }
        
        /* Tab styles */
        .tab-active {
            background: linear-gradient(to bottom, rgba(56, 189, 248, 0.2), transparent);
            border-bottom: 2px solid #38bdf8;
        }
        
        /* Timer ring animation */
        @keyframes countdown {
            from { stroke-dashoffset: 0; }
            to { stroke-dashoffset: 440; }
        }
        
        /* Alert animations */
        .alert-flash {
            animation: flash 0.5s ease-in-out infinite alternate;
        }
        
        @keyframes flash {
            from { background-color: rgba(239, 68, 68, 0.8); }
            to { background-color: rgba(239, 68, 68, 0.4); }
        }
        
        /* Wave animation for sound effects */
        .sound-wave {
            position: relative;
        }
        
        .sound-wave::before,
        .sound-wave::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 150%;
            height: 150%;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            z-index: -1;
        }
        
        .sound-wave::before {
            animation: wave 1.5s infinite;
        }
        
        .sound-wave::after {
            animation: wave 1.5s infinite 0.3s;
        }
        
        @keyframes wave {
            0% {
                width: 100%;
                height: 100%;
                opacity: 1;
            }
            100% {
                width: 150%;
                height: 150%;
                opacity: 0;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, createContext, useContext } = React;
        
        // Context for audio management
        const AudioContext = createContext();
        
        function AudioProvider({ children }) {
            // Inlined base64 encoded audio for better compatibility
            // This is a short "beep" sound encoded as base64
            const beepSound = "data:audio/mp3;base64,SUQzBAAAAAABEVRYWFgAAAAtAAADY29tbWVudABCaWdTb3VuZEJhbmsuY29tIC8gTGFTb25vdGhlcXVlLm9yZwBURU5DAAAAHQAAA1N3aXRjaCBQbHVzIMKpIE5DSCBTb2Z0d2FyZQBUSVQyAAAABgAAAzIyMzUAVFNTRQAAAA8AAANMYXZmNTcuODMuMTAwAAAAAAAAAAAAAAD/80DEAAAAA0gAAAAATEFNRTMuMTAwVVVVVVVVVVVVVUxBTUUzLjEwMFVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVf/zQsRbAAADSAAAAABVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVf/zQMSkAAADSAAAAABVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV";
            
            // Alarm sound (slightly longer)
            const alarmSound = "data:audio/mp3;base64,//uQxAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAAFAAAJrQBVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVWqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqrV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dX///////////////////////////////////////////8AAAA8TEFNRTMuOTlyBK8AAAAALAAAADTIJALBgwAARgAACa0UM51EAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//syxAAABDwBOmMEAAKHACccwIgAAAAEuLouLh/4iILi4uvRapNGpMvrJJC3f5QCGACACMwEhUCgJwxBkEwNC0CQ0Dc0EpxAgLgQFwPpJkoDuUawIwGBMAGBMCI8Cw6EoyTJ1DQ0Kh19dqRQsNDIuCwqo1KeWIWS0UCQEnHy7JBNKFhgZGhomD0XB4VHjkmdQ0aJA9GRZ6SZ9Dp7jCwyLjZK9fpJoaIQzB0Wx6XZ0KjIuOvXa3S+KTIuLi6+QXRcXF1j5mXFxcPnQX0nF1//+Xj/nBf//6Lp//g//+Z0uGC4f/LqR/mA4IggICAyD9CZDKAAC78ADASgGNwM7Bm4WxpTGdN81FWsNSk0QFH7JtKbOCyb3nInWJkiAIZQeGHBQsMNExM3gzHjPLA0zBAM2vDSDxON5I3pjezNdE10zdpM8AXEAMKAFjbTLEM0GzMGMzECM1LTIpMSDQMgKBQAIE5NAFBgwwJOQUBLWjQJRhEEhgAAZgYAJgQCCgnCTEIMbKSkhE6dWP/7MsQYABfKMR72KgALAUYfnsHABKEGG3MqIuKikbY66VqkLTWq0SSu0JMZQcG9IQiRSbFRKUW1FRtVZCOSkzPZTnVW9UdXRKTI0L7xwQzwgmI5lYlGxWS+CUjE0LTg0JJfBLUKrW2pVtK02VYztILjgv/4LJhBLkYiEvgmIJiiYvyK6apCUmZUXGOSjM+qVlL5RakxBTUUzLjk5LjWqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqv/7MsQAA8AAAf4AAAAIAAANIAAAASqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq";

            // Short click sound
            const clickSound = "data:audio/mp3;base64,SUQzBAAAAAABEVRYWFgAAAAtAAADY29tbWVudABCaWdTb3VuZEJhbmsuY29tIC8gTGFTb25vdGhlcXVlLm9yZwBURU5DAAAAHQAAA1N3aXRjaCBQbHVzIMKpIE5DSCBTb2Z0d2FyZQBUSVQyAAAABgAAAzIyMzUAVFNTRQAAAA8AAANMYXZmNTcuODMuMTAwAAAAAAAAAAAAAAD/80DEAAAAA0gAAAAATEFNRTMuMTAwVVVVVVVVVVVVVUxBTUUzLjEwMFVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVf/zQsRbAAADSAAAAABVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVf/zQMSkAAADSAAAAABVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV";
            
            // Create three audio objects for different sounds
            const beepRef = useRef(null);
            const alarmRef = useRef(null);
            const clickRef = useRef(null);
            
            // Initialize audio on component mount
            useEffect(() => {
                try {
                    beepRef.current = new Audio(beepSound);
                    alarmRef.current = new Audio(alarmSound);
                    clickRef.current = new Audio(clickSound);
                    
                    // Set properties
                    alarmRef.current.loop = true;
                    
                    // Attempt to load the audio files
                    beepRef.current.load();
                    alarmRef.current.load();
                    clickRef.current.load();
                    
                    console.log("Audio objects created successfully");
                } catch (error) {
                    console.error("Error creating Audio objects:", error);
                }
                
                // Cleanup
                return () => {
                    if (beepRef.current) beepRef.current.pause();
                    if (alarmRef.current) alarmRef.current.pause();
                    if (clickRef.current) clickRef.current.pause();
                }
            }, []);
            
            // Play functions
            const playBeep = () => {
                try {
                    if (beepRef.current) {
                        beepRef.current.currentTime = 0;
                        beepRef.current.play().catch(e => console.log("Audio play blocked:", e));
                    }
                } catch (e) {
                    console.error("Error playing beep sound:", e);
                }
            };
            
            const playAlarm = () => {
                try {
                    if (alarmRef.current) {
                        alarmRef.current.currentTime = 0;
                        alarmRef.current.play().catch(e => console.log("Audio play blocked:", e));
                    }
                } catch (e) {
                    console.error("Error playing alarm sound:", e);
                }
            };
            
            const stopAlarm = () => {
                try {
                    if (alarmRef.current) {
                        alarmRef.current.pause();
                        alarmRef.current.currentTime = 0;
                    }
                } catch (e) {
                    console.error("Error stopping alarm sound:", e);
                }
            };
            
            const playClick = () => {
                try {
                    if (clickRef.current) {
                        clickRef.current.currentTime = 0;
                        clickRef.current.play().catch(e => console.log("Audio play blocked:", e));
                    }
                } catch (e) {
                    console.error("Error playing click sound:", e);
                }
            };
            
            // Using unlockAudio to help with autoplay restrictions
            const unlockAudio = () => {
                try {
                    // Try to play all sounds briefly to unlock audio
                    if (beepRef.current) {
                        beepRef.current.play()
                            .then(() => beepRef.current.pause())
                            .catch(() => {}); // Silence errors
                    }
                    if (alarmRef.current) {
                        alarmRef.current.play()
                            .then(() => alarmRef.current.pause())
                            .catch(() => {}); 
                    }
                    if (clickRef.current) {
                        clickRef.current.play()
                            .then(() => clickRef.current.pause())
                            .catch(() => {});
                    }
                } catch (e) {
                    console.log("Audio unlock attempt:", e);
                }
            };
            
            return (
                <AudioContext.Provider value={{ 
                    playBeep, 
                    playAlarm, 
                    stopAlarm, 
                    playClick,
                    unlockAudio
                }}>
                    {children}
                </AudioContext.Provider>
            );
        }
        
        // Utility functions
        const formatTime = (totalSeconds, showHours = false) => {
            if (totalSeconds === null || isNaN(totalSeconds)) return "--:--";
            
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = Math.floor(totalSeconds % 60);
            
            if (showHours || hours > 0) {
                return \`\${hours.toString().padStart(2, '0')}:\${minutes.toString().padStart(2, '0')}:\${seconds.toString().padStart(2, '0')}\`;
            }
            
            return \`\${minutes.toString().padStart(2, '0')}:\${seconds.toString().padStart(2, '0')}\`;
        };

        // Digital Clock Component
        function DigitalClock() {
            const [time, setTime] = useState(new Date());
            
            useEffect(() => {
                const timerId = setInterval(() => {
                    setTime(new Date());
                }, 1000);
                
                return () => clearInterval(timerId);
            }, []);
            
            const formattedTime = time.toLocaleTimeString('de-DE', { 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit' 
            });
            
            return (
                <div className="text-4xl md:text-5xl font-bold monospace text-center text-cyan-300 timer-display">
                    {formattedTime}
                </div>
            );
        }
        
        // Analog Clock Component
        function AnalogClock() {
            const [time, setTime] = useState(new Date());
            
            useEffect(() => {
                const timerId = setInterval(() => {
                    setTime(new Date());
                }, 1000);
                
                return () => clearInterval(timerId);
            }, []);
            
            const secondDegrees = (time.getSeconds() / 60) * 360;
            const minuteDegrees = ((time.getMinutes() + time.getSeconds() / 60) / 60) * 360;
            const hourDegrees = ((time.getHours() % 12 + time.getMinutes() / 60) / 12) * 360;
            
            return (
                <div className="clock-face">
                    {/* Hour markers */}
                    {Array.from({ length: 12 }).map((_, i) => (
                        <div 
                            key={i} 
                            className="timer-marker"
                            style={{ transform: \`rotate(\${i * 30}deg)\` }}
                        ></div>
                    ))}
                    
                    {/* Clock hands */}
                    <div 
                        className="clock-hand hour-hand" 
                        style={{ transform: \`translate(-50%, 0) rotate(\${hourDegrees}deg)\` }}
                    ></div>
                    <div 
                        className="clock-hand minute-hand" 
                        style={{ transform: \`translate(-50%, 0) rotate(\${minuteDegrees}deg)\` }}
                    ></div>
                    <div 
                        className="clock-hand second-hand" 
                        style={{ transform: \`translate(-50%, 0) rotate(\${secondDegrees}deg)\` }}
                    ></div>
                    
                    <div className="clock-center"></div>
                </div>
            );
        }

        // Countdown Timer Component
        function CountdownTimer() {
            const [initialTime, setInitialTime] = useState(300); // 5 minutes in seconds
            const [timeLeft, setTimeLeft] = useState(null);
            const [isRunning, setIsRunning] = useState(false);
            const [isPaused, setIsPaused] = useState(false);
            const [isComplete, setIsComplete] = useState(false);
            const { playBeep, playAlarm, stopAlarm, playClick, unlockAudio } = useContext(AudioContext);
            
            const timerId = useRef(null);
            const lastTickTime = useRef(null);
            
            // Load saved time
            useEffect(() => {
                try {
                    const savedInitialTime = localStorage.getItem('timerInitialTime');
                    if (savedInitialTime) {
                        setInitialTime(parseInt(savedInitialTime, 10));
                    }
                } catch (e) {
                    console.log("No stored timer data or error accessing localStorage");
                }
            }, []);
            
            // Save initial time
            useEffect(() => {
                try {
                    localStorage.setItem('timerInitialTime', initialTime.toString());
                } catch (e) {
                    console.log("Error saving to localStorage");
                }
            }, [initialTime]);
            
            // Timer logic
            useEffect(() => {
                if (isRunning && !isPaused && timeLeft > 0) {
                    lastTickTime.current = Date.now();
                    
                    timerId.current = setInterval(() => {
                        const now = Date.now();
                        const delta = Math.floor((now - lastTickTime.current) / 1000);
                        lastTickTime.current = now;
                        
                        setTimeLeft(prev => {
                            const newTime = Math.max(0, prev - delta);
                            // Play a beep at specific times if not at zero
                            if (newTime > 0 && [60, 30, 10, 5, 4, 3, 2, 1].includes(newTime)) {
                                playBeep();
                            }
                            // Handle timer completion
                            if (prev > 0 && newTime === 0) {
                                setIsComplete(true);
                                setIsRunning(false);
                                playAlarm();
                            }
                            return newTime;
                        });
                    }, 100); // Check more frequently for accuracy
                    
                    return () => clearInterval(timerId.current);
                }
            }, [isRunning, isPaused, timeLeft, playBeep, playAlarm]);
            
            // Handle start
            const handleStart = () => {
                unlockAudio(); // Try to unlock audio
                playClick();
                setTimeLeft(initialTime);
                setIsRunning(true);
                setIsPaused(false);
                setIsComplete(false);
            };
            
            // Handle pause/resume
            const handlePauseResume = () => {
                playClick();
                setIsPaused(!isPaused);
            };
            
            // Handle reset
            const handleReset = () => {
                playClick();
                clearInterval(timerId.current);
                setTimeLeft(initialTime);
                setIsRunning(false);
                setIsPaused(false);
                setIsComplete(false);
                stopAlarm();
            };
            
            // Handle minutes change
            const handleMinutesChange = (e) => {
                const minutes = parseInt(e.target.value, 10) || 0;
                setInitialTime(minutes * 60 + (initialTime % 60));
            };
            
            // Handle seconds change
            const handleSecondsChange = (e) => {
                const seconds = parseInt(e.target.value, 10) || 0;
                setInitialTime(Math.floor(initialTime / 60) * 60 + seconds);
            };
            
            // Format progress ring
            const circumference = 2 * Math.PI * 70; // 70 is the radius of our SVG circle
            const strokeDashoffset = timeLeft ? ((initialTime - timeLeft) / initialTime) * circumference : 0;
            
            return (
                <div className="p-5 rounded-xl bg-gray-800/80 shadow-xl border border-gray-700">
                    {/* Timer display */}
                    <div className="relative">
                        <svg className="w-full h-56 progress-ring" viewBox="0 0 150 150">
                            {/* Background circle */}
                            <circle
                                cx="75"
                                cy="75"
                                r="70"
                                fill="none"
                                stroke="#334155"
                                strokeWidth="10"
                            />
                            
                            {/* Progress circle */}
                            {timeLeft !== null && (
                                <circle
                                    cx="75"
                                    cy="75"
                                    r="70"
                                    fill="none"
                                    stroke={isComplete ? "#ef4444" : "#0ea5e9"}
                                    strokeWidth="10"
                                    strokeDasharray={circumference}
                                    strokeDashoffset={strokeDashoffset}
                                    strokeLinecap="round"
                                    className={isComplete ? "animate-pulse-fast" : ""}
                                />
                            )}
                        </svg>
                        
                        {/* Time display */}
                        <div className="absolute inset-0 flex flex-col items-center justify-center">
                            <div className={\`text-5xl font-bold monospace timer-display mb-2 \${isComplete ? "text-red-400" : "text-cyan-300"}\`}>
                                {timeLeft !== null ? formatTime(timeLeft) : formatTime(initialTime)}
                            </div>
                            
                            {!isRunning && !isComplete && (
                                <div className="flex space-x-2 items-center mt-2">
                                    <input
                                        type="number"
                                        value={Math.floor(initialTime / 60)}
                                        onChange={handleMinutesChange}
                                        min="0"
                                        max="60"
                                        className="w-14 bg-gray-700 text-white text-center py-1 rounded border border-gray-600"
                                        disabled={isRunning}
                                    />
                                    <span className="text-gray-400">min</span>
                                    <input
                                        type="number"
                                        value={initialTime % 60}
                                        onChange={handleSecondsChange}
                                        min="0"
                                        max="59"
                                        className="w-14 bg-gray-700 text-white text-center py-1 rounded border border-gray-600"
                                        disabled={isRunning}
                                    />
                                    <span className="text-gray-400">sec</span>
                                </div>
                            )}
                        </div>
                    </div>
                    
                    {/* Quick presets */}
                    {!isRunning && !isComplete && (
                        <div className="grid grid-cols-4 gap-2 my-4">
                            {[1, 3, 5, 10].map(min => (
                                <button 
                                    key={min}
                                    className="btn-3d bg-gray-700 text-white text-sm py-2"
                                    onClick={() => {
                                        playClick();
                                        setInitialTime(min * 60);
                                    }}
                                >
                                    {min}m
                                </button>
                            ))}
                        </div>
                    )}
                    
                    {/* Timer controls */}
                    <div className="flex space-x-3 mt-4">
                        {!isRunning && !isComplete ? (
                            <button 
                                className="btn-3d flex-1 bg-gradient-to-r from-green-600 to-green-500 text-white"
                                onClick={handleStart}
                            >
                                <i className="fas fa-play mr-2"></i> Start
                            </button>
                        ) : (
                            <>
                                {isComplete ? (
                                    <button 
                                        className="btn-3d flex-1 bg-gradient-to-r from-amber-600 to-amber-500 text-white sound-wave"
                                        onClick={handleReset}
                                    >
                                        <i className="fas fa-stop mr-2"></i> Alarm stoppen
                                    </button>
                                ) : (
                                    <>
                                        <button 
                                            className="btn-3d flex-1 bg-gradient-to-r from-amber-600 to-amber-500 text-white"
                                            onClick={handlePauseResume}
                                        >
                                            {isPaused ? (
                                                <><i className="fas fa-play mr-2"></i> Fortsetzen</>
                                            ) : (
                                                <><i className="fas fa-pause mr-2"></i> Pause</>
                                            )}
                                        </button>
                                        <button 
                                            className="btn-3d flex-1 bg-gradient-to-r from-red-600 to-red-500 text-white"
                                            onClick={handleReset}
                                        >
                                            <i className="fas fa-stop mr-2"></i> Zurücksetzen
                                        </button>
                                    </>
                                )}
                            </>
                        )}
                    </div>
                </div>
            );
        }

        // Stopwatch Component
        function Stopwatch() {
            const [elapsedTime, setElapsedTime] = useState(0);
            const [isRunning, setIsRunning] = useState(false);
            const [laps, setLaps] = useState([]);
            const { playClick } = useContext(AudioContext);
            
            const startTimeRef = useRef(0);
            const timerId = useRef(null);
            
            // Stopwatch logic
            useEffect(() => {
                if (isRunning) {
                    startTimeRef.current = Date.now() - elapsedTime * 1000;
                    
                    timerId.current = setInterval(() => {
                        const elapsed = (Date.now() - startTimeRef.current) / 1000;
                        setElapsedTime(elapsed);
                    }, 10); // Update very frequently for accuracy
                    
                    return () => clearInterval(timerId.current);
                }
            }, [isRunning, elapsedTime]);
            
            // Handle start/stop
            const handleStartStop = () => {
                playClick();
                setIsRunning(!isRunning);
            };
            
            // Handle reset
            const handleReset = () => {
                playClick();
                clearInterval(timerId.current);
                setElapsedTime(0);
                setIsRunning(false);
                setLaps([]);
            };
            
            // Handle lap
            const handleLap = () => {
                playClick();
                setLaps(prevLaps => [
                    ...prevLaps, 
                    {
                        time: elapsedTime,
                        index: prevLaps.length + 1,
                        duration: prevLaps.length > 0 
                            ? elapsedTime - prevLaps[prevLaps.length - 1].time 
                            : elapsedTime
                    }
                ]);
            };
            
            // Format milliseconds for display
            const formatTimeWithMs = (seconds) => {
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                const ms = Math.floor((seconds % 1) * 1000);
                
                return \`\${mins.toString().padStart(2, '0')}:\${secs.toString().padStart(2, '0')}.\${ms.toString().padStart(3, '0').slice(0, 2)}\`;
            };
            
            return (
                <div className="p-5 rounded-xl bg-gray-800/80 shadow-xl border border-gray-700">
                    {/* Stopwatch display */}
                    <div className="my-4 text-center">
                        <div className="text-5xl font-bold monospace text-cyan-300 timer-display my-6">
                            {formatTimeWithMs(elapsedTime)}
                        </div>
                    </div>
                    
                    {/* Stopwatch controls */}
                    <div className="flex space-x-3 mb-4">
                        <button 
                            className={\`btn-3d flex-1 \${
                                isRunning 
                                    ? "bg-gradient-to-r from-red-600 to-red-500" 
                                    : "bg-gradient-to-r from-green-600 to-green-500"
                            } text-white\`}
                            onClick={handleStartStop}
                        >
                            {isRunning ? (
                                <><i className="fas fa-stop mr-2"></i> Stop</>
                            ) : (
                                <><i className="fas fa-play mr-2"></i> Start</>
                            )}
                        </button>
                        
                        {isRunning ? (
                            <button 
                                className="btn-3d flex-1 bg-gradient-to-r from-blue-600 to-blue-500 text-white"
                                onClick={handleLap}
                            >
                                <i className="fas fa-flag-checkered mr-2"></i> Runde
                            </button>
                        ) : (
                            <button 
                                className="btn-3d flex-1 bg-gradient-to-r from-gray-600 to-gray-500 text-white"
                                onClick={handleReset}
                                disabled={elapsedTime === 0}
                            >
                                <i className="fas fa-redo mr-2"></i> Zurücksetzen
                            </button>
                        )}
                    </div>
                    
                    {/* Laps list */}
                    {laps.length > 0 && (
                        <div className="mt-6">
                            <h3 className="text-lg font-semibold text-white mb-2">Runden</h3>
                            <div className="max-h-40 overflow-y-auto rounded border border-gray-700">
                                <table className="w-full text-gray-200">
                                    <thead className="bg-gray-700 sticky top-0">
                                        <tr>
                                            <th className="py-2 px-3 text-left w-12">#</th>
                                            <th className="py-2 px-3 text-left">Rundenzeit</th>
                                            <th className="py-2 px-3 text-right">Gesamtzeit</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {laps.slice().reverse().map((lap) => (
                                            <tr key={lap.index} className="border-t border-gray-700">
                                                <td className="py-2 px-3 text-gray-400">{lap.index}</td>
                                                <td className="py-2 px-3 monospace">{formatTimeWithMs(lap.duration)}</td>
                                                <td className="py-2 px-3 monospace text-right">{formatTimeWithMs(lap.time)}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // Interval Timer (for HIIT workouts, pomodoro, etc.)
        function IntervalTimer() {
            const [workTime, setWorkTime] = useState(25); // in seconds
            const [restTime, setRestTime] = useState(5); // in seconds
            const [rounds, setRounds] = useState(8);
            const [currentRound, setCurrentRound] = useState(0);
            const [isWork, setIsWork] = useState(true);
            const [timeLeft, setTimeLeft] = useState(null);
            const [isRunning, setIsRunning] = useState(false);
            const [isPaused, setIsPaused] = useState(false);
            const { playBeep, playAlarm, stopAlarm, playClick, unlockAudio } = useContext(AudioContext);
            
            const timerId = useRef(null);
            const lastTickTime = useRef(null);
            
            // Try to load saved settings
            useEffect(() => {
                try {
                    const savedSettings = localStorage.getItem('intervalSettings');
                    if (savedSettings) {
                        const { work, rest, numRounds } = JSON.parse(savedSettings);
                        setWorkTime(work);
                        setRestTime(rest);
                        setRounds(numRounds);
                    }
                } catch (e) {
                    console.log("Error loading interval settings");
                }
            }, []);
            
            // Save settings
            useEffect(() => {
                try {
                    if (!isRunning) {
                        localStorage.setItem('intervalSettings', JSON.stringify({
                            work: workTime,
                            rest: restTime,
                            numRounds: rounds
                        }));
                    }
                } catch (e) {
                    console.log("Error saving interval settings");
                }
            }, [workTime, restTime, rounds, isRunning]);
            
            // Timer logic
            useEffect(() => {
                if (isRunning && !isPaused && timeLeft !== null) {
                    lastTickTime.current = Date.now();
                    
                    timerId.current = setInterval(() => {
                        const now = Date.now();
                        const delta = Math.floor((now - lastTickTime.current) / 1000);
                        lastTickTime.current = now;
                        
                        setTimeLeft(prev => {
                            const newTime = Math.max(0, prev - delta);
                            
                            // Play sounds at specific times
                            if (newTime > 0 && [3, 2, 1].includes(newTime)) {
                                playBeep();
                            }
                            
                            // Handle interval change
                            if (prev > 0 && newTime === 0) {
                                if (isWork) {
                                    // Work period completed
                                    if (currentRound < rounds) {
                                        // Move to rest period
                                        setIsWork(false);
                                        setTimeout(() => {
                                            playAlarm();
                                            setTimeout(() => stopAlarm(), 1000);
                                            setTimeLeft(restTime);
                                        }, 500);
                                    } else {
                                        // All rounds completed
                                        setIsRunning(false);
                                        playAlarm();
                                        setTimeout(() => stopAlarm(), 3000);
                                    }
                                } else {
                                    // Rest period completed
                                    setCurrentRound(r => r + 1);
                                    setIsWork(true);
                                    setTimeout(() => {
                                        playAlarm();
                                        setTimeout(() => stopAlarm(), 1000);
                                        setTimeLeft(workTime);
                                    }, 500);
                                }
                            }
                            
                            return newTime;
                        });
                    }, 100);
                    
                    return () => clearInterval(timerId.current);
                }
            }, [isRunning, isPaused, timeLeft, isWork, currentRound, rounds, workTime, restTime, playBeep, playAlarm, stopAlarm]);
            
            // Start interval training
            const handleStart = () => {
                unlockAudio();
                playClick();
                setCurrentRound(1);
                setIsWork(true);
                setTimeLeft(workTime);
                setIsRunning(true);
                setIsPaused(false);
            };
            
            // Pause/resume
            const handlePauseResume = () => {
                playClick();
                setIsPaused(!isPaused);
            };
            
            // Reset
            const handleReset = () => {
                playClick();
                clearInterval(timerId.current);
                setTimeLeft(null);
                setCurrentRound(0);
                setIsRunning(false);
                setIsPaused(false);
                stopAlarm();
            };
            
            // Utility function to add/subtract time
            const adjustTime = (type, amount) => {
                playClick();
                if (type === 'work') {
                    setWorkTime(Math.max(5, workTime + amount));
                } else if (type === 'rest') {
                    setRestTime(Math.max(5, restTime + amount));
                } else if (type === 'rounds') {
                    setRounds(Math.max(1, rounds + amount));
                }
            };
            
            // Progress calculation
            const progress = (() => {
                if (timeLeft === null || !isRunning) return 0;
                
                const currentInterval = isWork ? workTime : restTime;
                return ((currentInterval - timeLeft) / currentInterval) * 100;
            })();
            
            return (
                <div className="p-5 rounded-xl bg-gray-800/80 shadow-xl border border-gray-700">
                    {/* Status display */}
                    <div className="mb-6 text-center">
                        {isRunning && (
                            <div className={\`text-xl font-bold mb-1 \${isWork ? "text-green-400" : "text-blue-400"}\`}>
                                {isWork ? "ARBEITEN" : "PAUSE"}
                            </div>
                        )}
                        
                        <div className={\`text-5xl font-bold monospace timer-display \${isWork ? "text-green-300" : "text-blue-300"}\`}>
                            {timeLeft !== null ? formatTime(timeLeft) : "00:00"}
                        </div>
                        
                        {isRunning && (
                            <div className="mt-3">
                                <div className="w-full h-2 bg-gray-700 rounded-full overflow-hidden">
                                    <div 
                                        className={\`h-full \${isWork ? "bg-green-500" : "bg-blue-500"}\`}
                                        style={{ width: \`\${progress}%\` }}
                                    ></div>
                                </div>
                                <div className="mt-2 text-gray-400">
                                    Runde {currentRound} von {rounds}
                                </div>
                            </div>
                        )}
                    </div>
                    
                    {/* Settings (only shown when not running) */}
                    {!isRunning && (
                        <div className="mb-6 space-y-4">
                            <div className="flex items-center justify-between">
                                <span className="text-gray-300">Arbeitszeit</span>
                                <div className="flex items-center space-x-2">
                                    <button 
                                        className="w-8 h-8 flex items-center justify-center bg-gray-700 hover:bg-gray-600 rounded"
                                        onClick={() => adjustTime('work', -5)}
                                    >
                                        <i className="fas fa-minus text-sm"></i>
                                    </button>
                                    <span className="w-16 text-center monospace">{workTime}s</span>
                                    <button 
                                        className="w-8 h-8 flex items-center justify-center bg-gray-700 hover:bg-gray-600 rounded"
                                        onClick={() => adjustTime('work', 5)}
                                    >
                                        <i className="fas fa-plus text-sm"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div className="flex items-center justify-between">
                                <span className="text-gray-300">Pausenzeit</span>
                                <div className="flex items-center space-x-2">
                                    <button 
                                        className="w-8 h-8 flex items-center justify-center bg-gray-700 hover:bg-gray-600 rounded"
                                        onClick={() => adjustTime('rest', -5)}
                                    >
                                        <i className="fas fa-minus text-sm"></i>
                                    </button>
                                    <span className="w-16 text-center monospace">{restTime}s</span>
                                    <button 
                                        className="w-8 h-8 flex items-center justify-center bg-gray-700 hover:bg-gray-600 rounded"
                                        onClick={() => adjustTime('rest', 5)}
                                    >
                                        <i className="fas fa-plus text-sm"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div className="flex items-center justify-between">
                                <span className="text-gray-300">Runden</span>
                                <div className="flex items-center space-x-2">
                                    <button 
                                        className="w-8 h-8 flex items-center justify-center bg-gray-700 hover:bg-gray-600 rounded"
                                        onClick={() => adjustTime('rounds', -1)}
                                    >
                                        <i className="fas fa-minus text-sm"></i>
                                    </button>
                                    <span className="w-16 text-center monospace">{rounds}</span>
                                    <button 
                                        className="w-8 h-8 flex items-center justify-center bg-gray-700 hover:bg-gray-600 rounded"
                                        onClick={() => adjustTime('rounds', 1)}
                                    >
                                        <i className="fas fa-plus text-sm"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div className="grid grid-cols-2 gap-3 mt-4">
                                <button 
                                    className="btn-3d bg-gradient-to-r from-green-600 to-green-500 text-white py-2"
                                    onClick={() => {
                                        playClick();
                                        setWorkTime(25);
                                        setRestTime(5);
                                        setRounds(8);
                                    }}
                                >
                                    <i className="fas fa-bolt mr-2"></i> Schnelles HIIT
                                </button>
                                <button 
                                    className="btn-3d bg-gradient-to-r from-blue-600 to-blue-500 text-white py-2"
                                    onClick={() => {
                                        playClick();
                                        setWorkTime(1500);
                                        setRestTime(300);
                                        setRounds(4);
                                    }}
                                >
                                    <i className="fas fa-brain mr-2"></i> Pomodoro
                                </button>
                            </div>
                        </div>
                    )}
                    
                    {/* Controls */}
                    <div className="flex space-x-3 mt-4">
                        {!isRunning ? (
                            <button 
                                className="btn-3d flex-1 bg-gradient-to-r from-green-600 to-green-500 text-white"
                                onClick={handleStart}
                            >
                                <i className="fas fa-play mr-2"></i> Start
                            </button>
                        ) : (
                            <>
                                <button 
                                    className="btn-3d flex-1 bg-gradient-to-r from-amber-600 to-amber-500 text-white"
                                    onClick={handlePauseResume}
                                >
                                    {isPaused ? (
                                        <><i className="fas fa-play mr-2"></i> Fortsetzen</>
                                    ) : (
                                        <><i className="fas fa-pause mr-2"></i> Pause</>
                                    )}
                                </button>
                                <button 
                                    className="btn-3d flex-1 bg-gradient-to-r from-red-600 to-red-500 text-white"
                                    onClick={handleReset}
                                >
                                    <i className="fas fa-stop mr-2"></i> Zurücksetzen
                                </button>
                            </>
                        )}
                    </div>
                </div>
            );
        }

        // Alarm Clock Component
        function AlarmClock() {
            const [currentTime, setCurrentTime] = useState(new Date());
            const [alarmTime, setAlarmTime] = useState('');
            const [isAlarmSet, setIsAlarmSet] = useState(false);
            const [isRinging, setIsRinging] = useState(false);
            const [hour, setHour] = useState('07');
            const [minute, setMinute] = useState('00');
            const [alarmTriggeredForMinute, setAlarmTriggeredForMinute] = useState(false);
            const { playAlarm, stopAlarm, playClick, unlockAudio } = useContext(AudioContext);
            
            const SNOOZE_DURATION = 9;
            const alarmCheckRef = useRef(null);
            const lastCheckedMinuteRef = useRef(null);
            
            // Effect to load alarm state
            useEffect(() => {
                try {
                    const storedAlarmTime = localStorage.getItem('alarmClockTime');
                    const storedIsAlarmSet = localStorage.getItem('alarmClockIsSet');
                    
                    if (storedAlarmTime) {
                        setAlarmTime(storedAlarmTime);
                        const [storedHour, storedMinute] = storedAlarmTime.split(':');
                        setHour(storedHour || '07');
                        setMinute(storedMinute || '00');
                    }
                    
                    if (storedIsAlarmSet === 'true') {
                        setIsAlarmSet(true);
                    }
                    
                    setAlarmTriggeredForMinute(false);
                    lastCheckedMinuteRef.current = new Date().getMinutes();
                } catch (e) {
                    console.log("Error loading alarm state");
                }
            }, []);
            
            // Effect to save alarm state
            useEffect(() => {
                try {
                    if (isAlarmSet && alarmTime) {
                        localStorage.setItem('alarmClockTime', alarmTime);
                        localStorage.setItem('alarmClockIsSet', 'true');
                    } else if (!isAlarmSet) {
                        localStorage.removeItem('alarmClockTime');
                        localStorage.removeItem('alarmClockIsSet');
                    }
                } catch (e) {
                    console.log("Error saving alarm state");
                }
            }, [alarmTime, isAlarmSet]);
            
            // Effect to update current time
            useEffect(() => {
                const timerId = setInterval(() => {
                    setCurrentTime(new Date());
                }, 1000);
                
                return () => clearInterval(timerId);
            }, []);
            
            // Effect to check if alarm should ring
            useEffect(() => {
                const now = currentTime;
                const currentHour = String(now.getHours()).padStart(2, '0');
                const currentMinute = String(now.getMinutes()).padStart(2, '0');
                const currentTimeFormatted = \`\${currentHour}:\${currentMinute}\`;
                const currentMinuteValue = now.getMinutes();
                
                // Reset trigger flag when minute changes
                if (currentMinuteValue !== lastCheckedMinuteRef.current) {
                    setAlarmTriggeredForMinute(false);
                    lastCheckedMinuteRef.current = currentMinuteValue;
                }
                
                // Check if alarm should ring
                if (isAlarmSet && !isRinging && alarmTime === currentTimeFormatted && !alarmTriggeredForMinute) {
                    setIsRinging(true);
                    setAlarmTriggeredForMinute(true);
                    playAlarm();
                }
                
                // Reset flag if alarm is cleared
                if (!isAlarmSet && alarmTriggeredForMinute) {
                    setAlarmTriggeredForMinute(false);
                }
            }, [currentTime, alarmTime, isAlarmSet, isRinging, alarmTriggeredForMinute, playAlarm]);
            
            // Set alarm
            const handleSetAlarm = () => {
                unlockAudio();
                playClick();
                const formattedHour = String(hour).padStart(2, '0');
                const formattedMinute = String(minute).padStart(2, '0');
                const newAlarmTime = \`\${formattedHour}:\${formattedMinute}\`;
                setAlarmTime(newAlarmTime);
                setIsAlarmSet(true);
                setIsRinging(false);
                setAlarmTriggeredForMinute(false);
                lastCheckedMinuteRef.current = new Date().getMinutes();
            };
            
            // Clear alarm
            const handleClearAlarm = () => {
                playClick();
                setAlarmTime('');
                setIsAlarmSet(false);
                setIsRinging(false);
                setAlarmTriggeredForMinute(false);
                stopAlarm();
            };
            
            // Stop ringing
            const handleStopRinging = () => {
                playClick();
                setIsRinging(false);
                stopAlarm();
                handleClearAlarm();
            };
            
            // Snooze
            const handleSnooze = () => {
                playClick();
                setIsRinging(false);
                stopAlarm();
                
                const now = new Date();
                const snoozeTime = new Date(now.getTime() + SNOOZE_DURATION * 60000);
                const snoozeHour = String(snoozeTime.getHours()).padStart(2, '0');
                const snoozeMinute = String(snoozeTime.getMinutes()).padStart(2, '0');
                const newAlarmTime = \`\${snoozeHour}:\${snoozeMinute}\`;
                
                setAlarmTime(newAlarmTime);
                setHour(snoozeHour);
                setMinute(snoozeMinute);
                setIsAlarmSet(true);
                setAlarmTriggeredForMinute(false);
                lastCheckedMinuteRef.current = snoozeTime.getMinutes();
            };
            
            // Input handlers
            const handleHourChange = (e) => {
                let value = e.target.value;
                if (value === '') {
                    setHour('');
                    return;
                }
                let numValue = parseInt(value, 10);
                if (isNaN(numValue)) numValue = 0;
                numValue = Math.max(0, Math.min(23, numValue));
                setHour(String(numValue).padStart(2, '0'));
            };
            
            const handleHourBlur = () => {
                if (hour === '') setHour('00');
            };
            
            const handleMinuteChange = (e) => {
                let value = e.target.value;
                if (value === '') {
                    setMinute('');
                    return;
                }
                let numValue = parseInt(value, 10);
                if (isNaN(numValue)) numValue = 0;
                numValue = Math.max(0, Math.min(59, numValue));
                setMinute(String(numValue).padStart(2, '0'));
            };
            
            const handleMinuteBlur = () => {
                if (minute === '') setMinute('00');
            };
            
            // Format time
            const formatTime = (date) => {
                return date.toLocaleTimeString('de-DE', {
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
            };
            
            return (
                <div className="p-5 rounded-xl bg-gray-800/80 shadow-xl border border-gray-700">
                    {/* Analog clock */}
                    <div className="mb-4">
                        <AnalogClock />
                    </div>
                    
                    {/* Digital clock */}
                    <div className="text-4xl md:text-5xl font-bold monospace text-center text-cyan-300 timer-display my-6">
                        {formatTime(currentTime)}
                    </div>
                    
                    {/* Ringing alert */}
                    {isRinging && (
                        <div className="mb-6 p-4 bg-gradient-to-r from-red-500 via-pink-500 to-red-500 border-2 border-red-300 text-white rounded-lg shadow-lg alert-flash">
                            <p className="font-bold text-center text-xl sm:text-2xl mb-4">ALARM!</p>
                            <div className="flex space-x-3">
                                <button 
                                    onClick={handleSnooze} 
                                    className="btn-3d flex-1 bg-gradient-to-r from-yellow-500 to-orange-500 hover:from-yellow-600 hover:to-orange-600 text-white"
                                >
                                    Schlummern ({SNOOZE_DURATION} Min)
                                </button>
                                <button 
                                    onClick={handleStopRinging} 
                                    className="btn-3d flex-1 bg-gradient-to-r from-red-600 to-pink-600 hover:from-red-700 hover:to-pink-700 text-white"
                                >
                                    Stoppen & Löschen
                                </button>
                            </div>
                        </div>
                    )}
                    
                    {/* Alarm settings */}
                    {!isRinging && (
                        <div className="mb-4">
                            <div className="flex justify-center items-center space-x-3 mb-6">
                                <div className="text-center">
                                    <label htmlFor="hour" className="block text-sm font-medium text-gray-400 mb-1">Stunde</label>
                                    <input
                                        type="number"
                                        id="hour"
                                        value={hour}
                                        onChange={handleHourChange}
                                        onBlur={handleHourBlur}
                                        className="block w-20 sm:w-24 px-3 py-3 bg-gray-700 border border-gray-600 rounded-md shadow-inner text-gray-100 focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 text-2xl sm:text-3xl text-center appearance-none monospace"
                                        placeholder="HH"
                                        min="0"
                                        max="23"
                                        disabled={isAlarmSet}
                                    />
                                </div>
                                <span className="text-3xl sm:text-4xl text-gray-500 pt-6 monospace">:</span>
                                <div className="text-center">
                                    <label htmlFor="minute" className="block text-sm font-medium text-gray-400 mb-1">Minute</label>
                                    <input
                                        type="number"
                                        id="minute"
                                        value={minute}
                                        onChange={handleMinuteChange}
                                        onBlur={handleMinuteBlur}
                                        className="block w-20 sm:w-24 px-3 py-3 bg-gray-700 border border-gray-600 rounded-md shadow-inner text-gray-100 focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 text-2xl sm:text-3xl text-center appearance-none monospace"
                                        placeholder="MM"
                                        min="0"
                                        max="59"
                                        disabled={isAlarmSet}
                                    />
                                </div>
                            </div>
                            <div className="space-y-3">
                                <button
                                    onClick={handleSetAlarm}
                                    className={\`btn-3d w-full text-white \${
                                        isAlarmSet
                                            ? "bg-gray-500 cursor-not-allowed"
                                            : "bg-gradient-to-r from-blue-500 to-cyan-500 hover:from-blue-600 hover:to-cyan-600"
                                    }\`}
                                    disabled={isAlarmSet}
                                >
                                    {isAlarmSet ? \`Alarm aktiv: \${alarmTime}\` : "Alarm stellen"}
                                </button>
                                {isAlarmSet && (
                                    <button
                                        onClick={handleClearAlarm}
                                        className="btn-3d w-full bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-600 hover:to-orange-600 text-white"
                                    >
                                        Alarm löschen
                                    </button>
                                )}
                            </div>
                        </div>
                    )}
                    
                    <div className="text-center text-xs text-gray-500 mt-6">
                        {isAlarmSet
                            ? isRinging
                                ? \`Alarm klingelt für \${alarmTime}\`
                                : \`Alarm gestellt für \${alarmTime}\`
                            : "Kein Alarm aktiv"}
                    </div>
                </div>
            );
        }

        // Main App Component
        function TimerApp() {
            const [activeTab, setActiveTab] = useState('timer');
            const { playClick } = useContext(AudioContext);
            
            // Updated tab change handler - moved playClick to happen after the state updates
            const handleTabChange = (tab) => {
                if (tab === activeTab) return; // Prevent unnecessary state updates
                setActiveTab(tab);
                
                // Small delay for the sound to avoid any timing issues
                setTimeout(() => {
                    playClick();
                }, 10);
            };
            
            return (
                <div className="min-h-screen py-6 px-4">
                    <div className="max-w-md mx-auto">
                        <h1 className="text-3xl font-bold text-center text-white mb-6">
                            <span className="bg-clip-text text-transparent bg-gradient-to-r from-cyan-400 to-blue-500">
                                Ultimate Timer Hub
                            </span>
                        </h1>
                        
                        {/* Tab navigation - improved with higher z-index to ensure clickability */}
                        <div className="flex bg-gray-800 rounded-xl mb-6 shadow-lg overflow-hidden relative z-10">
                            <button
                                className={\`flex-1 py-3 px-4 text-center focus:outline-none \${
                                    activeTab === 'timer' ? 'tab-active text-cyan-300' : 'text-gray-400 hover:text-white'
                                }\`}
                                onClick={() => handleTabChange('timer')}
                            >
                                <i className="fas fa-hourglass-half mr-2"></i>
                                Timer
                            </button>
                            <button
                                className={\`flex-1 py-3 px-4 text-center focus:outline-none \${
                                    activeTab === 'stopwatch' ? 'tab-active text-cyan-300' : 'text-gray-400 hover:text-white'
                                }\`}
                                onClick={() => handleTabChange('stopwatch')}
                            >
                                <i className="fas fa-stopwatch mr-2"></i>
                                Stoppuhr
                            </button>
                            <button
                                className={\`flex-1 py-3 px-4 text-center focus:outline-none \${
                                    activeTab === 'interval' ? 'tab-active text-cyan-300' : 'text-gray-400 hover:text-white'
                                }\`}
                                onClick={() => handleTabChange('interval')}
                            >
                                <i className="fas fa-exchange-alt mr-2"></i>
                                Intervall
                            </button>
                            <button
                                className={\`flex-1 py-3 px-4 text-center focus:outline-none \${
                                    activeTab === 'alarm' ? 'tab-active text-cyan-300' : 'text-gray-400 hover:text-white'
                                }\`}
                                onClick={() => handleTabChange('alarm')}
                            >
                                <i className="fas fa-bell mr-2"></i>
                                Wecker
                            </button>
                        </div>
                        
                        {/* Tab content */}
                        <div>
                            {activeTab === 'timer' && <CountdownTimer />}
                            {activeTab === 'stopwatch' && <Stopwatch />}
                            {activeTab === 'interval' && <IntervalTimer />}
                            {activeTab === 'alarm' && <AlarmClock />}
                        </div>
                        
                        <div className="text-center text-xs text-gray-500 mt-8">
                            Ultimate Timer Hub v2.0
                        </div>
                    </div>
                </div>
            );
        }

        // Render the app
        const App = () => (
            <AudioProvider>
                <TimerApp />
            </AudioProvider>
        );

        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    <\/script>
</body>
</html>
`;
    // --- END ULTIMATE TIMER HUB HTML ---


    // --- Reusable Components ---
    const ProgressBar = ({ value, max, color = 'bg-primary', showPercentage = false, height = "h-4" }) => {
      const numericValue = typeof value === 'number' && !isNaN(value) ? value : 0;
      const numericMax = typeof max === 'number' && !isNaN(max) && max > 0 ? max : 0;
      const perc = numericMax > 0 ? Math.min(100, Math.max(0, numericValue / numericMax * 100)) : 0;
      let barColor = color;
      if (!color.startsWith('bg-')) { // Auto-color based on percentage if no specific bg-color provided
        if (perc > 100) barColor = 'bg-danger';
        else if (perc >= 100) barColor = 'bg-success';
        else if (perc > 80) barColor = 'bg-warning';
        else if (perc > 50) barColor = 'bg-info';
        else barColor = 'bg-blue-400';
      }
      return (
        <div className={`w-full bg-gray-300 dark:bg-gray-700 rounded-full ${height} overflow-hidden shadow-inner mt-1 mb-2`}>
          <div className={`${barColor} ${height} rounded-full transition-all duration-500 flex items-center justify-end`} style={{ width: `${Math.min(100, perc)}%` }}>
            {showPercentage && perc > 15 && <span className="px-2 text-xs text-white font-semibold">{Math.round(perc)}%</span>}
          </div>
        </div>
      );
    };
    const Tabs = ({ active, setActive }) => {
      const { isDark } = useContext(ThemeContext);
      return (
        <div className="flex flex-wrap justify-center mb-8 gap-2">
          {Object.values(TABS).map(tab => (
            <button key={tab} onClick={() => setActive(tab)} className={`flex items-center gap-2 px-4 py-2 rounded-full font-semibold shadow transition-transform duration-150 ${active === tab ? 'bg-gradient-to-r from-pink-500 to-purple-600 text-white scale-105 shadow-lg' : isDark ? 'bg-gray-800 text-white hover:bg-gray-700 hover:scale-105' : 'bg-white text-gray-700 hover:bg-gray-100 hover:scale-105'}`}>
              {tab === 'dashboard' && <i className="fas fa-chart-pie"/>} {tab === 'food' && <i className="fas fa-utensils"/>} {tab === 'exercise' && <i className="fas fa-dumbbell"/>} {tab === 'goals' && <i className="fas fa-bullseye"/>} {tab === 'aging' && <i className="fas fa-leaf"/>} {tab === 'stats' && <i className="fas fa-chart-line"/>} {TAB_LABELS[tab]}
            </button>
          ))}
        </div>
      );
    };
    const Card = ({ title, color, children, className = "" }) => {
      const { isDark } = useContext(ThemeContext);
      return <div className={`p-5 rounded-2xl shadow-lg ${isDark ? 'bg-gray-800 text-white' : 'bg-white bg-opacity-90'} backdrop-blur-md border-t-4 card-transition ${className}`} style={{ borderColor: color }}><h3 className="font-semibold text-lg mb-4" style={{ color }}>{title}</h3>{children}</div>;
    };
    const LogList = ({ items, onDelete, renderItem }) => {
      const { isDark } = useContext(ThemeContext);
      return (
        items.length === 0
        ? <p className={`italic ${isDark ? 'text-gray-400' : 'text-gray-500'}`}>Keine Einträge für heute</p>
        : <ul className="space-y-3 max-h-96 overflow-y-auto pr-1">
            {items.map(i => (
              <li key={i.id} className={`flex justify-between items-center pb-2 border-b ${isDark ? 'border-gray-700' : 'border-gray-200'} last:border-0`}>
                <div className="flex-1 mr-2 overflow-hidden">{renderItem(i)}</div>
                <button title="Löschen" onClick={() => onDelete(i.id)} className="text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-100 dark:hover:bg-red-900 ml-2 flex-shrink-0"><i className="fas fa-trash"/></button>
              </li>
            ))}
          </ul>
      );
    };

    // --- Feature Components ---
    const WaterTracker = ({ waterData, setWaterState, goal }) => {
        const addWater = (amount) => {
            if (typeof amount !== 'number' || amount <= 0) return;
            const newItem = { id: crypto.randomUUID(), amount, timestamp: new Date().toISOString(), date: today };
            setWaterState(prev => [...prev, newItem]);
        };
        const deleteWater = (id) => { setWaterState(prev => prev.filter(w => w.id !== id)); };
        const todayWater = useMemo(() => waterData.filter(w => w.date === today), [waterData, today]);
        const totalWater = todayWater.reduce((sum, item) => sum + (item.amount || 0), 0);
        const percentage = goal > 0 ? Math.min(100, Math.round((totalWater / goal) * 100)) : 0;
        return (
            <div className="flex flex-col gap-3">
                <div className="flex items-end gap-2"><div className="flex-1"><div className="flex justify-between mb-1 text-sm"><span>{totalWater} ml</span><span>{goal} ml</span></div><div className="h-8 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden relative"><div className="h-full bg-blue-400 dark:bg-blue-600 transition-all duration-500 flex items-center justify-center" style={{ width: `${percentage}%` }}>{percentage > 15 && <span className="text-xs text-white font-semibold">{percentage}%</span>}</div><div className="absolute inset-0 pointer-events-none">{Array.from({ length: Math.max(1, Math.floor(goal / 500)) }).map((_, i) => (<div key={i} className="absolute top-0 bottom-0 border-r border-gray-300 dark:border-gray-600 opacity-50" style={{ left: `${((i + 1) * 500 / goal) * 100}%`, width: '1px' }}></div>))}</div></div></div><i className="fas fa-tint text-blue-500 text-2xl ml-1"></i></div>
                <div className="flex flex-wrap gap-2">{[200, 350, 500].map(amount => (<button key={amount} onClick={() => addWater(amount)} className="flex-1 min-w-[calc(33%-0.5rem)] py-2 px-3 rounded-lg bg-blue-100 hover:bg-blue-200 dark:bg-blue-900 dark:hover:bg-blue-800 font-medium text-blue-700 dark:text-blue-300 transition shadow-sm">+{amount}ml</button>))}</div>
                {todayWater.length > 0 && (<div className="mt-2 max-h-32 overflow-y-auto text-sm pr-1"><h4 className="font-semibold mb-1">Heute getrunken:</h4><ul className="space-y-1">{[...todayWater].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)).map((w) => (<li key={w.id} className="flex justify-between items-center"><span>{new Date(w.timestamp).toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' })} - {w.amount}ml</span><button onClick={() => deleteWater(w.id)} className="text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-100 dark:hover:bg-red-900 text-xs" aria-label="Wasser Eintrag löschen"><i className="fas fa-times"></i></button></li>))}</ul></div>)}
            </div>
        );
    };
    const WeightTracker = ({ weights, setWeights, targetWeight }) => {
        const [newWeight, setNewWeight] = useState('');
        const { isDark } = useContext(ThemeContext);
        const chartRef = useRef(null);
        const chartInstance = useRef(null);
        const addWeight = () => {
            if (!newWeight || isNaN(parseFloat(newWeight))) { alert("Bitte geben Sie eine gültige Zahl für das Gewicht ein."); return; }
            const weightVal = parseFloat(newWeight);
            if (weightVal < 20 || weightVal > 400) { alert("Bitte geben Sie ein realistisches Gewicht ein (20-400 kg)."); return; }
            setWeights(prev => {
                const existingIndex = prev.findIndex(w => w.date === today);
                if (existingIndex !== -1) { const updatedWeights = [...prev]; updatedWeights[existingIndex] = { ...updatedWeights[existingIndex], weight: weightVal }; return updatedWeights; }
                else { return [...prev, { id: crypto.randomUUID(), date: today, weight: weightVal }]; }
            });
            setNewWeight('');
        };
        const deleteWeight = (id) => setWeights(prev => prev.filter(w => w.id !== id));
        const sortedWeightsForList = useMemo(() => [...weights].sort((a, b) => new Date(b.date) - new Date(a.date)), [weights]);
        const currentWeight = sortedWeightsForList.length > 0 ? sortedWeightsForList[0].weight : null;
        const weightDiff = currentWeight !== null && typeof targetWeight === 'number' ? (currentWeight - targetWeight).toFixed(1) : null;
        useEffect(() => { // Chart logic
            if (weights.length < 1 || !chartRef.current) { if (chartInstance.current) { chartInstance.current.destroy(); chartInstance.current = null; } return; }
            const data = [...weights].sort((a, b) => new Date(a.date) - new Date(b.date)).slice(-30);
            const labels = data.map(w => getDateForDisplay(w.date));
            const weightData = data.map(w => w.weight);
            if (chartInstance.current) chartInstance.current.destroy();
            const ctx = chartRef.current.getContext('2d');
            chartInstance.current = new Chart(ctx, { type: 'line', data: { labels, datasets: [{ label: 'Gewicht (kg)', data: weightData, borderColor: '#8B5CF6', backgroundColor: 'rgba(139, 92, 246, 0.1)', tension: 0.3, fill: true, pointRadius: 3, pointBackgroundColor: '#8B5CF6' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { backgroundColor: isDark ? '#374151' : 'rgba(255, 255, 255, 0.9)', titleColor: isDark ? '#fff' : '#000', bodyColor: isDark ? '#fff' : '#000', borderColor: '#8B5CF6', borderWidth: 1, padding: 10, displayColors: false } }, scales: { y: { beginAtZero: false, grid: { color: isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)' }, ticks: { color: isDark ? '#fff' : '#000' } }, x: { grid: { display: false }, ticks: { color: isDark ? '#fff' : '#000', maxRotation: 45, minRotation: 45, autoSkip: true, maxTicksLimit: 10 } } } } });
            return () => { if (chartInstance.current) { chartInstance.current.destroy(); chartInstance.current = null; } };
        }, [weights, isDark, targetWeight]);
        return ( // JSX for WeightTracker
            <div className="space-y-4">
                <div className="flex gap-3 items-start"><div className="flex-1"><input type="number" value={newWeight} onChange={e => setNewWeight(e.target.value)} placeholder={`Heute (${today})`} step="0.1" min="20" max="400" className="w-full p-2 rounded border border-gray-300 dark:border-gray-700 dark:bg-gray-700 dark:text-white text-base focus:ring-2 focus:ring-purple-500 focus:border-transparent" aria-label="Gewicht in kg eingeben"/><p className="text-xs text-gray-500 dark:text-gray-400 mt-1">Gewicht in kg</p></div><button onClick={addWeight} className="px-4 py-2 rounded-lg bg-purple-500 hover:bg-purple-600 text-white font-semibold transition shadow-sm h-[42px]" aria-label="Gewicht speichern">Speichern</button></div>
                {currentWeight !== null && typeof targetWeight === 'number' && <div className="p-3 rounded-lg bg-gray-100 dark:bg-gray-700 flex items-center justify-between text-sm"><div><p>Aktuell: <span className="font-bold">{currentWeight} kg</span> ({getDateForDisplay(sortedWeightsForList[0].date)})</p><p>Ziel: <span className="font-bold">{targetWeight} kg</span></p></div>{weightDiff !== null && <div className={`text-lg font-bold ${weightDiff > 0 ? 'text-orange-500' : 'text-green-500'}`}>{weightDiff > 0 ? `+${weightDiff}` : weightDiff} kg</div>}</div>}
                {weights.length > 0 && <div className="h-48 w-full mt-4">{weights.length < 2 && <p className="text-center text-sm text-gray-500 dark:text-gray-400">Mehr Datenpunkte benötigt für Trend.</p>}<canvas ref={chartRef}></canvas></div>}
                {sortedWeightsForList.length > 0 && <div className="mt-2 max-h-64 overflow-y-auto pr-1"><h4 className="font-semibold mb-2">Gewichtsverlauf:</h4><div className="divide-y divide-gray-200 dark:divide-gray-700">{sortedWeightsForList.map(w => <div key={w.id} className="flex justify-between items-center py-2 text-sm"><div><span className="font-medium">{getDateForDisplay(w.date)}</span><span className="ml-4">{w.weight} kg</span></div><button onClick={() => deleteWeight(w.id)} className="text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-100 dark:hover:bg-red-900" aria-label={`Gewichtseintrag vom ${getDateForDisplay(w.date)} löschen`}><i className="fas fa-times"></i></button></div>)}</div></div>}
                {weights.length === 0 && <p className="text-center text-sm text-gray-500 dark:text-gray-400">Noch keine Gewichtseinträge vorhanden.</p>}
            </div>
        );
    };
    const LongevityTracker = ({ agingData, setAgingData }) => {
        const { isDark } = useContext(ThemeContext);
        const toggleItem = (id) => {
            setAgingData(prev => {
                const index = prev.findIndex(i => i.id === id && i.date === today);
                const itemDefinition = longevityItems.find(i => i.id === id);
                if (!itemDefinition) return prev;
                if (index >= 0) { // Item exists for today
                    const updatedItem = { ...prev[index] };
                    updatedItem.count = (updatedItem.count >= itemDefinition.target) ? 0 : updatedItem.count + 1;
                    const newData = [...prev]; newData[index] = updatedItem; return newData;
                } else { // Add new item for today
                    return [...prev, { id, count: 1, target: itemDefinition.target, date: today }];
                }
            });
        };
        const todayItems = useMemo(() => agingData.filter(i => i.date === today), [agingData, today]);
        const score = useMemo(() => { // Calculate score
            const totalPossiblePoints = longevityItems.reduce((sum, item) => sum + item.target, 0);
            if (totalPossiblePoints === 0) return 0;
            const achievedPoints = todayItems.reduce((sum, userItem) => {
                const definition = longevityItems.find(i => i.id === userItem.id);
                return sum + (definition && definition.target > 0 ? Math.min(userItem.count, definition.target) : 0);
            }, 0);
            return Math.round((achievedPoints / totalPossiblePoints) * 100);
        }, [todayItems]);
        const dailyTip = useMemo(() => { // Daily tip logic
            const tips = ["Nahrungsvielfalt fördert ein gesundes Mikrobiom. Ziele auf 30+ verschiedene Pflanzen pro Woche.", "Kälteexposition (z.B. kalte Duschen) kann braunes Fett aktivieren.", "Ausreichend Vitamin D ist wichtig für die Immunfunktion.", "Soziale Bindungen sind ein starker Prädiktor für Langlebigkeit.", "Reduziere verarbeitete Lebensmittel und Zucker."];
            const dayOfYear = Math.floor((new Date() - new Date(new Date().getFullYear(), 0, 0)) / 86400000);
            return tips[dayOfYear % tips.length];
        }, []);
        return ( // JSX for LongevityTracker
            <div className="space-y-6">
                <div className="flex flex-col sm:flex-row gap-6 items-center justify-between mb-6"><div className="text-center sm:text-left"><h2 className="text-2xl font-bold text-purple-700 dark:text-purple-400">Langlebigkeits-Score</h2><p className="text-gray-600 dark:text-gray-300">Deine täglichen Anti-Aging Aktivitäten</p></div><div className="relative w-32 h-32 flex-shrink-0"><svg className="absolute inset-0 w-full h-full" viewBox="0 0 100 100"><circle cx="50" cy="50" r="45" fill="none" stroke="#E2E8F0" strokeWidth="10" className="dark:stroke-gray-700"/><circle cx="50" cy="50" r="45" fill="none" stroke={score >= 80 ? "#22C55E" : score >= 50 ? "#F59E0B" : "#8B5CF6"} strokeWidth="10" strokeDasharray="282.7" strokeDashoffset={282.7 - (282.7 * score / 100)} strokeLinecap="round" transform="rotate(-90 50 50)" style={{ transition: 'stroke-dashoffset 0.5s ease-in-out' }}/></svg><div className="absolute inset-0 flex items-center justify-center"><div className="text-center"><span className="text-3xl font-bold">{score}%</span></div></div></div></div>
                <div className="grid sm:grid-cols-2 gap-4">{longevityItems.map(item => { const userItem = todayItems.find(i => i.id === item.id) || { count: 0, target: item.target }; const isComplete = userItem.count >= item.target; return (<div key={item.id} className={`p-4 rounded-lg border-l-4 ${isComplete ? 'border-green-500 bg-green-50 dark:bg-green-900/20' : 'border-purple-400 bg-purple-50 dark:bg-purple-900/20'} cursor-pointer hover:shadow-md transition-all duration-200 group`} onClick={() => toggleItem(item.id)} role="button" tabIndex="0" onKeyPress={(e) => { if (e.key === 'Enter' || e.key === ' ') toggleItem(item.id); }}><div className="flex items-start gap-3"><div className={`w-6 h-6 flex-shrink-0 rounded-full flex items-center justify-center mt-0.5 border ${isComplete ? 'bg-green-500 text-white border-green-600' : 'bg-white dark:bg-gray-800 border-purple-400 group-hover:bg-purple-100 dark:group-hover:bg-purple-800'} transition-colors duration-200`}>{isComplete && <i className="fas fa-check text-xs"></i>}{!isComplete && userItem.count > 0 && <span className="text-xs font-bold text-purple-600 dark:text-purple-300">{userItem.count}</span>}</div><div className="flex-1"><div className="flex justify-between items-center"><p className="font-semibold">{item.title}</p><span className={`text-sm font-medium ${isComplete ? 'text-green-600 dark:text-green-400' : 'text-purple-600 dark:text-purple-400'}`}>{userItem.count}/{item.target}</span></div><p className={`text-sm ${isDark ? 'text-gray-300' : 'text-gray-600'}`}>{item.info}</p></div></div></div>); })}</div>
                <div className="p-4 rounded-lg bg-blue-50 dark:bg-blue-900/20 border-l-4 border-blue-500"><h3 className="font-semibold text-blue-700 dark:text-blue-400 flex items-center gap-2"><i className="fas fa-lightbulb"></i>Langlebigkeits-Tipp des Tages</h3><p className="mt-2 text-gray-700 dark:text-gray-300">{dailyTip}</p></div>
            </div>
        );
    };
    const StatsView = ({ food, exercise, water, weights, agingData, goals }) => {
        const { isDark } = useContext(ThemeContext);
        const activityChartRef = useRef(null); const activityChartInstance = useRef(null);
        const weightChartRef = useRef(null); const weightChartInstance = useRef(null);
        const [currentStreak, longestStreak] = useMemo(() => { // Streak calculation
            const activityDays = new Set();
            [...food, ...exercise, ...water, ...agingData].forEach(item => { if (item.date && typeof item.date === 'string' && !isNaN(new Date(item.date))) activityDays.add(item.date); });
            const sortedDays = Array.from(activityDays).sort((a, b) => new Date(a) - new Date(b));
            if (sortedDays.length === 0) return [0, 0];
            let current = 0, longest = 0, streakCounter = 0; const todayStr = formatDate(new Date());
            for (let i = 0; i < sortedDays.length; i++) { if (i > 0) { const curr = new Date(sortedDays[i]); const prev = new Date(sortedDays[i - 1]); const diffDays = Math.round((curr - prev) / 86400000); if (diffDays === 1) streakCounter++; else { longest = Math.max(longest, streakCounter); streakCounter = 1; } } else streakCounter = 1; longest = Math.max(longest, streakCounter); }
            if (sortedDays.includes(todayStr)) { current = 1; let dayIndex = sortedDays.indexOf(todayStr); while (dayIndex > 0) { const curr = new Date(sortedDays[dayIndex]); const prev = new Date(sortedDays[dayIndex - 1]); if (Math.round((curr - prev) / 86400000) === 1) { current++; dayIndex--; } else break; } }
            return [current, longest];
        }, [food, exercise, water, agingData]);
        useEffect(() => { // Activity Chart (7 days)
            if (!activityChartRef.current) return;
            const dates = Array.from({length: 7}, (_, i) => { const d = new Date(); d.setDate(d.getDate() - (6 - i)); return formatDate(d); });
            const getCount = (arr, date) => arr.filter(item => item.date === date).length;
            const getWaterAmount = (arr, date) => arr.filter(item => item.date === date).reduce((sum, w) => sum + w.amount, 0);
            const foodCounts = dates.map(date => getCount(food, date));
            const exerciseCounts = dates.map(date => getCount(exercise, date));
            const waterAmounts = dates.map(date => (getWaterAmount(water, date) / 1000).toFixed(1));
            const longevityScores = dates.map(date => { const dayItems = agingData.filter(i => i.date === date); const totalTargets = longevityItems.reduce((sum, item) => sum + item.target, 0); if (totalTargets === 0) return 0; const achieved = dayItems.reduce((sum, item) => { const definition = longevityItems.find(i => i.id === item.id); return sum + (definition ? Math.min(item.count, definition.target) : 0); }, 0); return Math.round((achieved / totalTargets) * 100); });
            const displayDates = dates.map(date => new Date(date).toLocaleDateString('de-DE', { weekday: 'short' }));
            if (activityChartInstance.current) activityChartInstance.current.destroy();
            const ctx = activityChartRef.current.getContext('2d');
            activityChartInstance.current = new Chart(ctx, { type: 'bar', data: { labels: displayDates, datasets: [{ label: 'Mahlzeiten', data: foodCounts, backgroundColor: '#8B5CF6', borderRadius: 4, order: 1 }, { label: 'Übungen', data: exerciseCounts, backgroundColor: '#22C55E', borderRadius: 4, order: 2 }, { label: 'Wasser (L)', type: 'line', data: waterAmounts, borderColor: '#3B82F6', backgroundColor: 'rgba(59, 130, 246, 0.1)', yAxisID: 'yWater', tension: 0.3, fill: false, pointRadius: 3, order: 0 }, { label: 'Langlebigkeit (%)', type: 'line', data: longevityScores, borderColor: '#F59E0B', backgroundColor: 'rgba(245, 158, 11, 0.1)', yAxisID: 'yScore', tension: 0.3, fill: false, pointRadius: 3, order: 0 }] }, options: { responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false }, plugins: { legend: { position: 'bottom', labels: { color: isDark ? '#fff' : '#000', padding: 15 } }, tooltip: { backgroundColor: isDark ? '#374151' : 'rgba(255, 255, 255, 0.9)', titleColor: isDark ? '#fff' : '#000', bodyColor: isDark ? '#fff' : '#000', borderColor: '#8B5CF6', borderWidth: 1, padding: 10, displayColors: true } }, scales: { y: { beginAtZero: true, position: 'left', grid: { color: isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)' }, ticks: { color: isDark ? '#fff' : '#000', stepSize: 1 }, title: { display: true, text: 'Anzahl Aktivitäten', color: isDark ? '#fff' : '#000' } }, yWater: { beginAtZero: true, position: 'right', grid: { drawOnChartArea: false }, ticks: { color: '#3B82F6' }, title: { display: true, text: 'Wasser (L)', color: '#3B82F6' } }, yScore: { beginAtZero: true, max: 100, position: 'right', grid: { drawOnChartArea: false }, ticks: { color: '#F59E0B' }, title: { display: true, text: 'Langlebigkeit (%)', color: '#F59E0B' }, offset: true }, x: { grid: { display: false }, ticks: { color: isDark ? '#fff' : '#000' } } } } });
            return () => { if (activityChartInstance.current) { activityChartInstance.current.destroy(); activityChartInstance.current = null; } };
        }, [food, exercise, water, agingData, isDark]);
        useEffect(() => { // Weight Chart (All time)
            if (weights.length < 1 || !weightChartRef.current) { if (weightChartInstance.current) { weightChartInstance.current.destroy(); weightChartInstance.current = null; } return; }
            const data = [...weights].sort((a, b) => new Date(a.date) - new Date(b.date));
            const labels = data.map(w => getDateForDisplay(w.date));
            const weightData = data.map(w => w.weight);
            const targetLine = Array(data.length).fill(goals.targetWeight);
            if (weightChartInstance.current) weightChartInstance.current.destroy();
            const ctx = weightChartRef.current.getContext('2d');
            weightChartInstance.current = new Chart(ctx, { type: 'line', data: { labels, datasets: [{ label: 'Gewicht (kg)', data: weightData, borderColor: '#8B5CF6', backgroundColor: 'rgba(139, 92, 246, 0.1)', tension: 0.1, fill: true, pointRadius: 2, pointBackgroundColor: '#8B5CF6' }, { label: 'Zielgewicht (kg)', data: targetLine, borderColor: '#F59E0B', borderDash: [5, 5], fill: false, pointRadius: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: true, position: 'bottom', labels: { color: isDark ? '#fff' : '#000' } }, tooltip: {} }, scales: { y: { beginAtZero: false, grid: { color: isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)' }, ticks: { color: isDark ? '#fff' : '#000' } }, x: { grid: { display: false }, ticks: { color: isDark ? '#fff' : '#000', autoSkip: true, maxTicksLimit: 15 } } } } });
            return () => { if (weightChartInstance.current) { weightChartInstance.current.destroy(); weightChartInstance.current = null; } };
        }, [weights, goals.targetWeight, isDark]);
        const totalExerciseMinutes = exercise.reduce((sum, e) => sum + e.duration, 0);
        const totalWaterLiters = (water.reduce((sum, w) => sum + w.amount, 0) / 1000).toFixed(1);
        const totalDaysTracked = useMemo(() => { const days = new Set(); [...food, ...exercise, ...water, ...agingData, ...weights].forEach(item => { if (item.date) days.add(item.date); }); return days.size; }, [food, exercise, water, agingData, weights]);
        return ( // JSX for StatsView
            <div className="space-y-6">
                <h2 className="text-2xl font-bold text-center text-purple-700 dark:text-purple-400 mb-6">Statistiken & Trends</h2>
                <div className="grid md:grid-cols-2 lg:grid-cols-4 gap-5">
                    <div className={`p-5 rounded-2xl shadow-lg ${isDark ? 'bg-gray-800' : 'bg-white bg-opacity-90'} flex flex-col items-center text-center`}><i className="fas fa-fire-alt text-4xl text-orange-500 mb-3"></i><h3 className="font-semibold text-lg mb-1">Aktuelle Strähne</h3><p className="text-3xl font-bold mb-2">{currentStreak} <span className="text-lg font-normal">Tage</span></p><p className="text-sm text-gray-600 dark:text-gray-400">Längste: {longestStreak} Tage</p></div>
                    <div className={`p-5 rounded-2xl shadow-lg ${isDark ? 'bg-gray-800' : 'bg-white bg-opacity-90'} flex flex-col items-center text-center`}><i className="fas fa-calendar-check text-4xl text-blue-500 mb-3"></i><h3 className="font-semibold text-lg mb-1">Tage getrackt</h3><p className="text-3xl font-bold mb-2">{totalDaysTracked}</p><p className="text-sm text-gray-600 dark:text-gray-400">Gesamte Aktivitätstage</p></div>
                    <div className={`p-5 rounded-2xl shadow-lg ${isDark ? 'bg-gray-800' : 'bg-white bg-opacity-90'} flex flex-col items-center text-center`}><i className="fas fa-dumbbell text-4xl text-green-500 mb-3"></i><h3 className="font-semibold text-lg mb-1">Training Gesamt</h3><p className="text-3xl font-bold mb-2">{totalExerciseMinutes} <span className="text-lg font-normal">Min</span></p><p className="text-sm text-gray-600 dark:text-gray-400">Alle Trainingseinheiten</p></div>
                    <div className={`p-5 rounded-2xl shadow-lg ${isDark ? 'bg-gray-800' : 'bg-white bg-opacity-90'} flex flex-col items-center text-center`}><i className="fas fa-tint text-4xl text-cyan-500 mb-3"></i><h3 className="font-semibold text-lg mb-1">Wasser Gesamt</h3><p className="text-3xl font-bold mb-2">{totalWaterLiters} <span className="text-lg font-normal">L</span></p><p className="text-sm text-gray-600 dark:text-gray-400">Gesamte Trinkmenge</p></div>
                </div>
                <Card title="Aktivitäten & Langlebigkeit (Letzte 7 Tage)" color="#22c55e"><div className="h-72 md:h-96 w-full"><canvas ref={activityChartRef}></canvas></div><p className="text-xs text-center mt-2 text-gray-500 dark:text-gray-400">Zeigt Mahlzeiten-/Übungsanzahl, Wasser (L) und Langlebigkeitsscore (%).</p></Card>
                <Card title="Gewichtsverlauf (Gesamt)" color="#f59e0b"><div className="h-72 md:h-96 w-full">{weights.length < 1 && <p className="text-center flex items-center justify-center h-full text-gray-500 dark:text-gray-400">Keine Gewichtsdaten zum Anzeigen.</p>}<canvas ref={weightChartRef}></canvas></div><p className="text-xs text-center mt-2 text-gray-500 dark:text-gray-400">Zeigt dein Gewicht und dein Zielgewicht über die Zeit.</p></Card>
            </div>
        );
    };

    // --- Main App Component ---
    function App() {
      // State
      const [goals, setGoals] = useState(() => safeGet(LS_KEYS.GOALS, initialGoals));
      const [food, setFood] = useState(() => safeGet(LS_KEYS.FOOD, []));
      const [exercise, setExercise] = useState(() => safeGet(LS_KEYS.EX, []));
      const [water, setWater] = useState(() => safeGet(LS_KEYS.WATER, [])); // Main water state
      const [weights, setWeights] = useState(() => safeGet(LS_KEYS.WEIGHT, []));
      const [agingData, setAgingData] = useState(() => safeGet(LS_KEYS.AGING, []));
      const [active, setActive] = useState(TABS.DASH);
      const [formErrors, setFormErrors] = useState({});
      const [tempGoals, setTempGoals] = useState(goals);
      const [savedText, setSavedText] = useState('');
      const [showTimer, setShowTimer] = useState(false); // State for timer visibility
      const { isDark, toggleTheme } = useContext(ThemeContext);

      // Memos for today's data
      const todayFood = useMemo(() => food.filter(f => f.date === today), [food, today]);
      const todayExercise = useMemo(() => exercise.filter(e => e.date === today), [exercise, today]);
      const todayWater = useMemo(() => water.filter(w => w.date === today), [water, today]);
      const todayAgingData = useMemo(() => agingData.filter(a => a.date === today), [agingData, today]);

      // Effects for saving to storage
      useEffect(() => { try { storage.setItem(LS_KEYS.GOALS, JSON.stringify(goals)); } catch(e){ console.warn("Failed to save goals", e)} }, [goals]);
      useEffect(() => { try { storage.setItem(LS_KEYS.FOOD, JSON.stringify(food)); } catch(e){ console.warn("Failed to save food", e)} }, [food]);
      useEffect(() => { try { storage.setItem(LS_KEYS.EX, JSON.stringify(exercise)); } catch(e){ console.warn("Failed to save exercise", e)} }, [exercise]);
      useEffect(() => { try { storage.setItem(LS_KEYS.WATER, JSON.stringify(water)); } catch(e){ console.warn("Failed to save water", e)} }, [water]);
      useEffect(() => { try { storage.setItem(LS_KEYS.WEIGHT, JSON.stringify(weights)); } catch(e){ console.warn("Failed to save weights", e)} }, [weights]);
      useEffect(() => { try { storage.setItem(LS_KEYS.AGING, JSON.stringify(agingData)); } catch(e){ console.warn("Failed to save aging data", e)} }, [agingData]);

      // Update tempGoals if global goals change
      useEffect(() => { setTempGoals(goals); }, [goals]);

      // Calculated totals for today
      const totals = useMemo(() => {
        const cal = todayFood.reduce((s, i) => s + (i.calories || 0), 0);
        const prot = todayFood.reduce((s, i) => s + (i.protein || 0), 0);
        const carbs = todayFood.reduce((s, i) => s + (i.carbs || 0), 0);
        const fat = todayFood.reduce((s, i) => s + (i.fat || 0), 0);
        const burned = todayExercise.reduce((s, i) => s + (i.caloriesBurned || 0), 0);
        const waterAmount = todayWater.reduce((s, i) => s + (i.amount || 0), 0);
        return { cal, prot, carbs, fat, burned, net: cal - burned, water: waterAmount };
      }, [todayFood, todayExercise, todayWater]);

      // Action Handlers
      const saveGoals = () => {
        if (Object.values(tempGoals).some(val => typeof val !== 'number' || val < 0)) { alert("Bitte geben Sie gültige, positive Zahlen für alle Ziele ein."); return; }
        setGoals(tempGoals); setSavedText("✅ Ziele gespeichert!"); setTimeout(() => setSavedText(''), 2000);
      };
      const addFood = () => {
        const name = document.getElementById('foodName').value.trim();
        const calories = parseFloat(document.getElementById('foodCalories').value) || 0;
        const protein = parseFloat(document.getElementById('foodProtein').value) || 0;
        const carbs = parseFloat(document.getElementById('foodCarbs').value) || 0;
        const fat = parseFloat(document.getElementById('foodFat').value) || 0;
        const errors = {}; if (!name) errors.name = "Name ist erforderlich."; if (calories <= 0) errors.calories = "Kalorien müssen positiv sein."; if (protein < 0) errors.protein = "Protein kann nicht negativ sein."; if (carbs < 0) errors.carbs = "Kohlenhydrate können nicht negativ sein."; if (fat < 0) errors.fat = "Fett kann nicht negativ sein.";
        setFormErrors(errors);
        if (Object.keys(errors).length === 0) {
          setFood(prev => [...prev, { id: crypto.randomUUID(), name, calories, protein, carbs, fat, date: today }]);
          document.getElementById('foodName').value = ''; document.getElementById('foodCalories').value = ''; document.getElementById('foodProtein').value = ''; document.getElementById('foodCarbs').value = ''; document.getElementById('foodFat').value = ''; setFormErrors({});
        }
      };
      const addExercise = () => {
        const name = document.getElementById('exName').value.trim();
        const duration = parseInt(document.getElementById('exDuration').value, 10) || 0;
        const caloriesBurned = parseFloat(document.getElementById('exCalories').value) || 0;
        const errors = {}; if (!name) errors.name = "Name ist erforderlich."; if (duration <= 0) errors.duration = "Dauer muss positiv sein."; if (caloriesBurned < 0) errors.caloriesBurned = "Verbrannte Kalorien können nicht negativ sein.";
        setFormErrors(errors);
        if (Object.keys(errors).length === 0) {
          setExercise(prev => [...prev, { id: crypto.randomUUID(), name, duration, caloriesBurned, date: today }]);
          document.getElementById('exName').value = ''; document.getElementById('exDuration').value = ''; document.getElementById('exCalories').value = ''; setFormErrors({});
        }
      };
      const deleteFood = id => setFood(prev => prev.filter(i => i.id !== id));
      const deleteExercise = id => setExercise(prev => prev.filter(i => i.id !== id));

      // --- Reset Function ---
      const resetAllData = () => {
        if (window.confirm("Bist du sicher, dass du ALLE deine Daten löschen möchtest? Diese Aktion kann nicht rückgängig gemacht werden!")) {
            console.log("Resetting all data...");
            // Reset state variables
            setGoals(initialGoals);
            setFood([]);
            setExercise([]);
            setWater([]);
            setWeights([]);
            setAgingData([]);
            setTempGoals(initialGoals); // Reset temp goals as well
            setActive(TABS.DASH); // Go back to dashboard

            // Clear storage
            Object.values(LS_KEYS).forEach(key => {
                try {
                    storage.removeItem(key);
                    console.log(`Removed ${key} from storage.`);
                } catch (e) {
                    console.warn(`Could not remove ${key} from storage.`, e);
                }
            });

             // Optional: Clear theme preference as well
             try {
                 storage.removeItem('themePref');
             } catch (e) {
                 console.warn("Could not remove theme preference from storage.", e);
             }

            console.log("Data reset complete.");
            alert("Alle Daten wurden zurückgesetzt."); // Inform user
        }
      };
      // --- End Reset Function ---


      // Today's Longevity Score for Header
      const todayLongevityScore = useMemo(() => {
          const totalTargets = longevityItems.reduce((sum, item) => sum + item.target, 0);
          if (totalTargets === 0) return 0;
          const achieved = todayAgingData.reduce((sum, item) => { const definition = longevityItems.find(i => i.id === item.id); return sum + (definition ? Math.min(item.count, definition.target) : 0); }, 0);
          return Math.round((achieved / totalTargets) * 100);
      }, [todayAgingData]);

      // --- Render App ---
      return (
        <div className="max-w-5xl mx-auto px-4 py-8">
          {/* Header */}
          <div className="flex justify-between items-center mb-6 flex-wrap gap-2">
            <h1 className="font-extrabold text-2xl sm:text-3xl text-purple-700 dark:text-purple-400 flex items-center"><i className="fas fa-heartbeat mr-2 text-pink-500"/>Fitness & Langlebigkeit</h1>
            <button onClick={toggleTheme} className="p-2 rounded-full bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors" aria-label={isDark ? "Light Mode aktivieren" : "Dark Mode aktivieren"}>{isDark ? <i className="fas fa-sun text-yellow-300"/> : <i className="fas fa-moon text-gray-700"/>}</button>
          </div>
          {/* Date & Score Header */}
          <div className="mb-6 p-3 rounded-xl bg-gradient-to-r from-blue-50 to-purple-50 dark:from-blue-900/20 dark:to-purple-900/20 text-sm text-center shadow-sm"><p className="text-gray-700 dark:text-gray-300"><span className="font-medium">{getDateForDisplay()}</span><span className="mx-2 text-gray-400 dark:text-gray-600">•</span><span>Langlebigkeits-Score heute: <span className="font-semibold text-purple-600 dark:text-purple-400">{todayLongevityScore}%</span></span></p></div>
          {/* Tabs */}
          <Tabs active={active} setActive={setActive} />

          {/* --- Tab Content --- */}
          {/* DASHBOARD */}
          {active === TABS.DASH && (
            <div className="space-y-6 animate-fade-in">
              {/* --- Ultimate Timer Hub Section --- */}
              <div className={`p-4 rounded-lg shadow ${isDark ? 'bg-gray-800/50' : 'bg-white/50'} backdrop-blur-sm border ${isDark ? 'border-gray-700' : 'border-gray-200'}`}>
                <button
                  onClick={() => setShowTimer(!showTimer)}
                  className={`mb-3 px-4 py-2 rounded-lg font-semibold transition flex items-center gap-2 shadow-sm ${
                    showTimer
                      ? 'bg-amber-500 hover:bg-amber-600 text-white'
                      : 'bg-blue-500 hover:bg-blue-600 text-white'
                  }`}
                >
                  <i className={`fas ${showTimer ? 'fa-clock-rotate-left' : 'fa-stopwatch-20'}`}></i>
                  {showTimer ? 'Timer ausblenden' : 'Timer Hub anzeigen'}
                </button>
                <div className={`iframe-container ${showTimer ? 'h-[650px] opacity-100' : 'h-0 opacity-0'}`}>
                  {showTimer && (
                    <iframe
                      srcDoc={ultimateTimerHubHtml}
                      title="Ultimate Timer Hub"
                      className="w-full h-full border-0 rounded-md"
                      sandbox="allow-scripts allow-same-origin" // allow-same-origin is needed for localStorage within the iframe
                    ></iframe>
                  )}
                </div>
              </div>
              {/* --- End Ultimate Timer Hub Section --- */}

              <div className="grid md:grid-cols-3 gap-5">
                <Card title="Kalorienbilanz" color="#3b82f6"><div className="flex items-center justify-between mb-2 text-sm"><div><p>Aufgenommen: {totals.cal} kcal</p><p>Verbrannt: {totals.burned} kcal</p><p className="font-semibold">Netto: {totals.net} kcal</p></div><div className="text-4xl text-blue-500 dark:text-blue-400"><i className="fas fa-fire-alt"></i></div></div><p className="text-xs text-gray-500 dark:text-gray-400 mb-1">Ziel: {goals.dailyCalories} kcal</p><ProgressBar value={totals.net} max={goals.dailyCalories} showPercentage={true}/></Card>
                <Card title="Makronährstoffe" color="#8b5cf6"><div className="space-y-3 text-sm"><div><div className="flex justify-between"><span>Protein: {totals.prot}g</span><span>Ziel: {goals.dailyProtein}g</span></div><ProgressBar value={totals.prot} max={goals.dailyProtein} color="bg-red-400"/></div><div><div className="flex justify-between"><span>Kohlenhydrate: {totals.carbs}g</span><span>Ziel: {goals.dailyCarbs}g</span></div><ProgressBar value={totals.carbs} max={goals.dailyCarbs} color="bg-yellow-400"/></div><div><div className="flex justify-between"><span>Fett: {totals.fat}g</span><span>Ziel: {goals.dailyFat}g</span></div><ProgressBar value={totals.fat} max={goals.dailyFat} color="bg-green-400"/></div></div></Card>
                <Card title="Training & Hydration" color="#22c55e"><div className="space-y-4 text-sm"><div><p>Verbrannte Kalorien: {totals.burned} kcal</p><p>Trainingsdauer: {todayExercise.reduce((s, i) => s + (i.duration || 0), 0)} Min</p><p className="text-xs text-gray-500 dark:text-gray-400 mt-1">Ziel: {goals.exerciseMinutes} Min/Tag</p></div><div className="pt-3 border-t border-gray-200 dark:border-gray-700"><div className="flex justify-between items-center mb-1"><span>Wasser: {(totals.water / 1000).toFixed(1)} L</span><span>Ziel: {goals.dailyWater / 1000} L</span><i className="fas fa-tint text-blue-500 ml-1"></i></div><ProgressBar value={totals.water} max={goals.dailyWater} color="bg-blue-400" showPercentage={true} /></div></div></Card>
              </div>
              <div className="grid md:grid-cols-2 gap-5">
                <Card title="Körpergewicht Tracker" color="#f59e0b"><WeightTracker weights={weights} setWeights={setWeights} targetWeight={goals.targetWeight} /></Card>
                <Card title="Hydration Tracker (Heute)" color="#3b82f6">
                  <WaterTracker waterData={water} setWaterState={setWater} goal={goals.dailyWater} />
                </Card>
              </div>
              <Card title="Langlebigkeits-Aktivitäten (Heute)" color="#a855f7"><div className="flex flex-wrap gap-2">{longevityItems.map(item => { const userItem = todayAgingData.find(i => i.id === item.id); const isComplete = userItem && userItem.count >= item.target; const currentCount = userItem ? userItem.count : 0; return (<button key={item.id} onClick={() => { const index = agingData.findIndex(i => i.id === item.id && i.date === today); const itemDefinition = longevityItems.find(i => i.id === item.id); if (index >= 0) { const updatedItem = { ...agingData[index] }; updatedItem.count = (updatedItem.count >= itemDefinition.target) ? 0 : updatedItem.count + 1; const newData = [...agingData]; newData[index] = updatedItem; setAgingData(newData); } else { setAgingData(prev => [...prev, { id: item.id, count: 1, target: itemDefinition.target, date: today }]); } }} className={`px-3 py-1.5 rounded-full flex items-center gap-1.5 transition-all duration-200 text-xs shadow-sm ${isComplete ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200 ring-1 ring-green-300 dark:ring-green-700' : currentCount > 0 ? 'bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200 ring-1 ring-purple-300 dark:ring-purple-700' : isDark ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-gray-100 text-gray-800 hover:bg-gray-200'}`} title={`${item.title} (${currentCount}/${item.target})`}>{isComplete ? <i className="fas fa-check-circle text-green-500"></i> : currentCount > 0 ? <i className="fas fa-spinner fa-spin text-purple-500"></i> : <i className="far fa-circle text-gray-400"></i>}<span>{item.title.split(' ')[0]}</span>{item.target > 1 && <span className="text-xs px-1.5 py-0.5 rounded-full bg-opacity-70 bg-white dark:bg-gray-800">{currentCount}/{item.target}</span>}</button>); })}</div><button onClick={() => setActive(TABS.AGING)} className="mt-4 text-sm text-purple-600 dark:text-purple-400 hover:underline">Alle Langlebigkeits-Details anzeigen <i className="fas fa-arrow-right ml-1"></i></button></Card>
            </div>
          )}
          {/* FOOD TAB */}
          {active === TABS.FOOD && (
            <div className="space-y-6 animate-fade-in">
              <Card title="Neues Lebensmittel hinzufügen" color="#3b82f6"><div className="grid md:grid-cols-3 gap-4 items-start"><div className="space-y-3"><div><label htmlFor="foodName" className="block text-sm font-medium mb-1">Name*</label><input type="text" id="foodName" placeholder="z.B. Hähnchenbrust" className={`w-full p-2 rounded border text-base ${formErrors.name ? 'border-red-500 bg-red-50 dark:bg-red-900/20' : 'border-gray-300 dark:border-gray-600 dark:bg-gray-700'}`} />{formErrors.name && <p className="text-red-500 text-xs mt-1">{formErrors.name}</p>}</div><div><label htmlFor="foodCalories" className="block text-sm font-medium mb-1">Kalorien (kcal)*</label><input type="number" id="foodCalories" placeholder="z.B. 165" min="0" className={`w-full p-2 rounded border text-base ${formErrors.calories ? 'border-red-500 bg-red-50 dark:bg-red-900/20' : 'border-gray-300 dark:border-gray-600 dark:bg-gray-700'}`} />{formErrors.calories && <p className="text-red-500 text-xs mt-1">{formErrors.calories}</p>}</div></div><div className="space-y-3"><div><label htmlFor="foodProtein" className="block text-sm font-medium mb-1">Protein (g)</label><input type="number" id="foodProtein" placeholder="z.B. 31" min="0" step="0.1" className={`w-full p-2 rounded border text-base ${formErrors.protein ? 'border-red-500 bg-red-50 dark:bg-red-900/20' : 'border-gray-300 dark:border-gray-600 dark:bg-gray-700'}`} />{formErrors.protein && <p className="text-red-500 text-xs mt-1">{formErrors.protein}</p>}</div><div><label htmlFor="foodCarbs" className="block text-sm font-medium mb-1">Kohlenhydrate (g)</label><input type="number" id="foodCarbs" placeholder="z.B. 0" min="0" step="0.1" className={`w-full p-2 rounded border text-base ${formErrors.carbs ? 'border-red-500 bg-red-50 dark:bg-red-900/20' : 'border-gray-300 dark:border-gray-600 dark:bg-gray-700'}`} />{formErrors.carbs && <p className="text-red-500 text-xs mt-1">{formErrors.carbs}</p>}</div></div><div className="space-y-3"><div><label htmlFor="foodFat" className="block text-sm font-medium mb-1">Fett (g)</label><input type="number" id="foodFat" placeholder="z.B. 3.6" min="0" step="0.1" className={`w-full p-2 rounded border text-base ${formErrors.fat ? 'border-red-500 bg-red-50 dark:bg-red-900/20' : 'border-gray-300 dark:border-gray-600 dark:bg-gray-700'}`} />{formErrors.fat && <p className="text-red-500 text-xs mt-1">{formErrors.fat}</p>}</div><div className="pt-5"><button onClick={addFood} className="w-full px-4 py-2 rounded-lg bg-blue-500 hover:bg-blue-600 text-white font-semibold transition shadow-sm"><i className="fas fa-plus mr-2"/>Hinzufügen</button></div></div></div></Card>
              <Card title="Essensprotokoll (Heute)" color="#3b82f6">{todayFood.length > 0 && <div className="mb-4 p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg"><p className="font-medium mb-2">Heutige Zusammenfassung:</p><div className="grid grid-cols-2 sm:grid-cols-4 gap-2 text-sm text-center"><div className="p-2 bg-blue-100 dark:bg-blue-900/30 rounded"><p className="text-blue-700 dark:text-blue-400 text-xs">Kalorien</p><p className="font-bold">{totals.cal} kcal</p></div><div className="p-2 bg-red-100 dark:bg-red-900/30 rounded"><p className="text-red-700 dark:text-red-400 text-xs">Protein</p><p className="font-bold">{totals.prot} g</p></div><div className="p-2 bg-yellow-100 dark:bg-yellow-900/30 rounded"><p className="text-yellow-700 dark:text-yellow-400 text-xs">Kohlenhydrate</p><p className="font-bold">{totals.carbs} g</p></div><div className="p-2 bg-green-100 dark:bg-green-900/30 rounded"><p className="text-green-700 dark:text-green-400 text-xs">Fett</p><p className="font-bold">{totals.fat} g</p></div></div>{totals.cal > 0 && <p className="text-xs text-center mt-2 text-gray-600 dark:text-gray-400">Verteilung: P: {Math.round(totals.prot * 4 / totals.cal * 100)}% | KH: {Math.round(totals.carbs * 4 / totals.cal * 100)}% | F: {Math.round(totals.fat * 9 / totals.cal * 100)}%</p>}</div>}<LogList items={todayFood} onDelete={deleteFood} renderItem={i => <><p className="font-medium">{i.name}</p><p className="text-sm text-gray-600 dark:text-gray-400 break-words">{i.calories} kcal | <span className="text-red-500 dark:text-red-400">P:{i.protein}g</span> | <span className="text-yellow-500 dark:text-yellow-400">KH:{i.carbs}g</span> | <span className="text-green-500 dark:text-green-400">F:{i.fat}g</span></p></>}/></Card>
            </div>
          )}
          {/* EXERCISE TAB */}
          {active === TABS.EX && (
            <div className="space-y-6 animate-fade-in">
              <Card title="Neues Training hinzufügen" color="#22c55e"><div className="grid md:grid-cols-3 gap-4 items-start"><div><label htmlFor="exName" className="block text-sm font-medium mb-1">Übung/Aktivität*</label><input type="text" id="exName" placeholder="z.B. Laufen, Krafttraining" className={`w-full p-2 rounded border text-base ${formErrors.name ? 'border-red-500 bg-red-50 dark:bg-red-900/20' : 'border-gray-300 dark:border-gray-600 dark:bg-gray-700'}`} />{formErrors.name && <p className="text-red-500 text-xs mt-1">{formErrors.name}</p>}</div><div><label htmlFor="exDuration" className="block text-sm font-medium mb-1">Dauer (Minuten)*</label><input type="number" id="exDuration" placeholder="z.B. 30" min="1" className={`w-full p-2 rounded border text-base ${formErrors.duration ? 'border-red-500 bg-red-50 dark:bg-red-900/20' : 'border-gray-300 dark:border-gray-600 dark:bg-gray-700'}`} />{formErrors.duration && <p className="text-red-500 text-xs mt-1">{formErrors.duration}</p>}</div><div><label htmlFor="exCalories" className="block text-sm font-medium mb-1">Kalorien verbrannt (kcal)</label><input type="number" id="exCalories" placeholder="Optional, z.B. 250" min="0" className={`w-full p-2 rounded border text-base ${formErrors.caloriesBurned ? 'border-red-500 bg-red-50 dark:bg-red-900/20' : 'border-gray-300 dark:border-gray-600 dark:bg-gray-700'}`} />{formErrors.caloriesBurned && <p className="text-red-500 text-xs mt-1">{formErrors.caloriesBurned}</p>}</div></div><button onClick={addExercise} className="mt-4 px-4 py-2 rounded-lg bg-green-500 hover:bg-green-600 text-white font-semibold transition shadow-sm"><i className="fas fa-plus mr-2"/>Hinzufügen</button></Card>
              <div className="grid md:grid-cols-1 gap-5"><Card title="Trainingsprotokoll (Heute)" color="#22c55e"><LogList items={todayExercise} onDelete={deleteExercise} renderItem={i => <><p className="font-medium">{i.name}</p><p className="text-sm text-gray-600 dark:text-gray-400">{i.duration} Min {i.caloriesBurned > 0 ? `| ${i.caloriesBurned} kcal verbrannt` : ''}</p></>}/>{todayExercise.length > 0 && <div className="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700"><div className="flex flex-wrap justify-between text-sm gap-2"><span>Gesamtzeit heute: <span className="font-semibold">{todayExercise.reduce((s, i) => s + i.duration, 0)} Min</span></span>{totals.burned > 0 && <span>Gesamt verbrannt: <span className="font-semibold">{totals.burned} kcal</span></span>}</div><p className="text-xs text-gray-500 dark:text-gray-400 mt-1">Tagesziel: {goals.exerciseMinutes} Min</p></div>}</Card></div>
            </div>
          )}
          {/* GOALS TAB */}
          {active === TABS.GOALS && (
            <div className="space-y-6 animate-fade-in">
              <Card title="Deine Ziele festlegen" color="#f59e0b">
                {/* Goal Inputs */}
                <div className="grid md:grid-cols-2 gap-x-6 gap-y-4 mb-6">{Object.keys(initialGoals).map(key => { const labelsMap = { targetWeight: "Zielgewicht (kg)", dailyCalories: "Tägliche Kalorien (kcal)", dailyProtein: "Tägliches Protein (g)", dailyCarbs: "Tägliche Kohlenhydrate (g)", dailyFat: "Tägliches Fett (g)", dailyWater: "Tägliches Wasser (ml)", exerciseMinutes: "Tägliches Training (Min)" }; const stepMap = { dailyWater: 100, targetWeight: 0.1 }; return (<div className="flex flex-col" key={key}><label htmlFor={`goal-${key}`} className="mb-1 font-medium text-sm">{labelsMap[key]}</label><input type="number" id={`goal-${key}`} value={tempGoals[key] ?? 0} onChange={e => { const value = e.target.value; setTempGoals({...tempGoals, [key]: value === '' ? '' : parseFloat(value) }); }} onBlur={e => { if (e.target.value === '') setTempGoals({...tempGoals, [key]: 0 }); }} className="p-2 rounded border text-base dark:bg-gray-700 dark:border-gray-600 focus:ring-2 focus:ring-purple-500 focus:border-transparent" min="0" step={stepMap[key] || 1}/></div>); })}</div>
                {/* Save Button */}
                <div className="flex items-center gap-4">
                    <button onClick={saveGoals} className="px-5 py-2 rounded-lg bg-purple-500 hover:bg-purple-600 text-white font-semibold transition shadow-sm"><i className="fas fa-save mr-2"/>Ziele speichern</button>
                    <div className="text-green-600 font-semibold h-6 transition-opacity duration-300" style={{ opacity: savedText ? 1 : 0 }}>{savedText}</div>
                </div>
                 {/* Reset Button Area */}
                 <div className="mt-8 pt-6 border-t border-gray-200 dark:border-gray-700">
                     <h4 className="font-semibold text-lg mb-3 text-danger">Daten zurücksetzen</h4>
                     <p className="text-sm text-gray-600 dark:text-gray-400 mb-4">
                         Achtung: Hiermit werden alle deine gespeicherten Daten (Ziele, Mahlzeiten, Training, Wasser, Gewicht, Langlebigkeit) unwiderruflich gelöscht.
                     </p>
                     <button
                         onClick={resetAllData}
                         className="px-5 py-2 rounded-lg bg-danger hover:bg-red-700 text-white font-semibold transition shadow-sm flex items-center gap-2"
                     >
                         <i className="fas fa-exclamation-triangle mr-1"></i>
                         Alle Daten löschen & Zurücksetzen
                     </button>
                 </div>
              </Card>
              <Card title="Tipps für realistische Ziele" color="#3b82f6"><div className="space-y-3 text-sm"><div className="p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg border-l-4 border-blue-400"><p className="font-medium text-blue-700 dark:text-blue-400">SMART Ziele</p><p className="text-gray-700 dark:text-gray-300">Setze <span className="font-semibold">S</span>pezifische, <span className="font-semibold">M</span>essbare, <span className="font-semibold">A</span>ttraktive, <span className="font-semibold">R</span>ealistische, <span className="font-semibold">T</span>erminierte Ziele.</p></div><div className="p-3 bg-purple-50 dark:bg-purple-900/20 rounded-lg border-l-4 border-purple-400"><p className="font-medium text-purple-700 dark:text-purple-400">Proteinbedarf</p><p className="text-gray-700 dark:text-gray-300">1,6-2,2g Protein pro kg Körpergewicht sind oft empfohlen für Muskelaufbau/-erhalt bei Training.</p></div><div className="p-3 bg-green-50 dark:bg-green-900/20 rounded-lg border-l-4 border-green-400"><p className="font-medium text-green-700 dark:text-green-400">Hydration</p><p className="text-gray-700 dark:text-gray-300">~30-40ml Wasser pro kg Körpergewicht ist ein guter Startpunkt. Mehr bei Hitze/Sport.</p></div><div className="p-3 bg-yellow-50 dark:bg-yellow-900/20 rounded-lg border-l-4 border-yellow-400"><p className="font-medium text-yellow-700 dark:text-yellow-400">Kaloriendefizit/-überschuss</p><p className="text-gray-700 dark:text-gray-300">Ein moderates Defizit (300-500 kcal) fördert nachhaltigen Fettverlust. Ein kleiner Überschuss (200-400 kcal) unterstützt Muskelaufbau.</p></div></div></Card>
            </div>
          )}
          {/* AGING TAB */}
          {active === TABS.AGING && (
            <div className="animate-fade-in"><LongevityTracker agingData={agingData} setAgingData={setAgingData} /></div>
          )}
          {/* STATS TAB */}
          {active === TABS.STATS && (
            <div className="animate-fade-in"><StatsView food={food} exercise={exercise} water={water} weights={weights} agingData={agingData} goals={goals} /></div>
          )}

          {/* Footer */}
          <footer className="mt-12 text-center text-xs text-gray-500 dark:text-gray-400"><p>Deine Daten werden {storage === localStorage ? 'lokal im Browser gespeichert.' : 'nur temporär für diese Sitzung gespeichert (localStorage nicht verfügbar).'}</p><p className="mt-1">Version 3.4 © {new Date().getFullYear()}</p></footer>
        </div>
      );
    }

    // --- Error Boundary ---
    class ErrorBoundary extends Component {
      constructor(props) { super(props); this.state = { hasError: false, error: null, errorInfo: null }; }
      static getDerivedStateFromError(error) { return { hasError: true }; }
      componentDidCatch(error, errorInfo) { console.error("Error caught by boundary:", error, errorInfo); this.setState({ error: error, errorInfo: errorInfo }); }
      render() {
        if (this.state.hasError) {
          const isDark = document.documentElement.classList.contains('dark');
          return (
            <div className="max-w-2xl mx-auto my-10"><div className={`p-6 rounded-xl shadow-lg text-center ${isDark ? 'bg-gray-800 text-white' : 'bg-white'}`}><div className="mb-4 text-red-500"><i className="fas fa-exclamation-triangle text-4xl"></i></div><h2 className="text-2xl font-bold mb-4">Ein Fehler ist aufgetreten</h2><p className="mb-4">Entschuldigung, die Anwendung konnte nicht korrekt geladen werden. Bitte versuche, die Seite neu zu laden.</p><div className="mb-4"><button onClick={() => window.location.reload()} className="px-4 py-2 bg-purple-500 hover:bg-purple-600 text-white rounded-lg transition"><i className="fas fa-sync-alt mr-2"></i>Seite neu laden</button></div>{this.state.error && <details className="text-left mt-4 p-4 bg-gray-100 dark:bg-gray-700 rounded-lg text-xs"><summary className="cursor-pointer font-medium mb-2">Technische Details</summary><p className="text-red-600 dark:text-red-400 mb-2">{this.state.error.toString()}</p>{this.state.errorInfo?.componentStack && <pre className="overflow-auto p-2 bg-gray-200 dark:bg-gray-800 rounded max-h-40">{this.state.errorInfo.componentStack}</pre>}</details>}</div></div>
          );
        }
        return this.props.children;
      }
    }

    // --- Render App ---
    const AppWithErrorHandling = () => (<ThemeProvider><ErrorBoundary><App /></ErrorBoundary></ThemeProvider>);
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<AppWithErrorHandling />);

  </script>
</body>
</html>
